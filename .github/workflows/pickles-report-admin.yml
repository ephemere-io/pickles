name: Pickles Multi-User Report Admin

on:
  workflow_dispatch: # ÊâãÂãïÂÆüË°å
    inputs:
      spreadsheet_id:
        description: '„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID (Á©∫„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅÆAdmin List„Çí‰ΩøÁî®)'
        required: false
        type: string
      analysis_type:
        description: 'ÂàÜÊûê„Çø„Ç§„Éó'
        required: false
        default: 'domi'
        type: choice
        options:
          - domi
          - aga
      delivery_method:
        description: 'ÈÖç‰ø°ÊñπÊ≥ï'
        required: false
        default: 'email_html'
        type: choice
        options:
          - email_html
          - email_text
          - console
          - file_text
          - file_html
      days_back:
        description: '‰ΩïÊó•Ââç„Åã„Çâ„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„Çã„Åã'
        required: false
        default: '30'
        type: string
      debug_mode:
        description: '„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÔºàË©≥Á¥∞„É≠„Ç∞„ÇíÂá∫ÂäõÔºâ'
        required: false
        default: false
        type: boolean

jobs:
  send-report:
    runs-on: ubuntu-latest
    environment: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Set up Python
      run: uv python install 3.12
    
    - name: Install dependencies
      run: uv sync --frozen
    
    - name: Run Multi-User Pickles analysis
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
        EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
        GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
      run: |
        # Áí∞Â¢ÉÂ§âÊï∞„Åã„ÇâË®≠ÂÆö„ÇíÂèñÂæóÔºàÊâãÂãïÂÆüË°å„ÅÆ„ÅøÔºâ
        # „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊßãÈÄ†: EMAIL_TO | NOTION_API_KEY | GOOGLE_DOCS_URL | USER_NAME | LANGUAGE
        # „Éá„Éº„Çø„ÇΩ„Éº„ÇπÂÑ™ÂÖàÈ†Ü‰Ωç: Notion > Google Docs
        SPREADSHEET_ID="${{ github.event.inputs.spreadsheet_id || secrets.SPREADSHEET_ID_ADMIN_LIST }}"
        echo "üîß ÊâãÂãïÂÆüË°å: „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID: ${SPREADSHEET_ID:0:10}..."
        
        ANALYSIS="${{ github.event.inputs.analysis_type || 'domi' }}"
        DELIVERY="${{ github.event.inputs.delivery_method || 'email_html' }}"
        DAYS="${{ github.event.inputs.days_back || '30' }}"
        
        # ÂøÖÈ†à„Éë„É©„É°„Éº„Çø„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
        if [[ -z "$SPREADSHEET_ID" ]]; then
          echo "‚ùå ERROR: SPREADSHEET_ID is not set in secrets"
          exit 1
        fi
        
        # „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅÆÁ¢∫Ë™ç
        if [[ "${{ github.event.inputs.debug_mode }}" == "true" ]]; then
          echo "=== Debug Mode Enabled ==="
          echo "Spreadsheet ID: $SPREADSHEET_ID"
          echo "Analysis Type: $ANALYSIS"
          echo "Delivery Method: $DELIVERY"
          echo "Days Back: $DAYS"
          echo "Environment variables status:"
          echo "OPENAI_API_KEY: ${OPENAI_API_KEY:+SET}"
          echo "EMAIL_USER: ${EMAIL_USER:+SET}"
          echo "EMAIL_PASS: ${EMAIL_PASS:+SET}"
          echo "EMAIL_HOST: ${EMAIL_HOST:+SET}"
          echo "EMAIL_PORT: ${EMAIL_PORT:+SET}"
          echo "GOOGLE_SERVICE_ACCOUNT_KEY: ${GOOGLE_SERVICE_ACCOUNT_KEY:+SET}"
          echo "========================"
        fi
        
        # Google Sheets„Åã„Çâ„Éû„É´„ÉÅ„É¶„Éº„Ç∂„ÉºÂÆüË°å
        uv run python read_spreadsheet_and_execute.py \
          --spreadsheet-id "$SPREADSHEET_ID" \
          --analysis "$ANALYSIS" \
          --delivery "$DELIVERY" \
          --days "$DAYS"