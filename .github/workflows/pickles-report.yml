name: Pickles Multi-User Report

on:
  schedule:
    # æ¯é€±æ—¥æœ¬æ™‚é–“æœˆæ›œæ—¥ã®åˆå‰7æ™‚ï¼ˆå‰æ—¥ã®UTC 23:00ï¼‰ã«å®Ÿè¡Œ
    - cron: '0 22 * * 0'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œ
    inputs:
      spreadsheet_id:
        description: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID (ç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çµ±åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨)'
        required: false
        type: string
      analysis_type:
        description: 'åˆ†æã‚¿ã‚¤ãƒ—'
        required: false
        default: 'domi'
        type: choice
        options:
          - domi
          - aga
      delivery_method:
        description: 'é…ä¿¡æ–¹æ³•'
        required: false
        default: 'email_html'
        type: choice
        options:
          - email_html
          - email_text
          - console
          - file_text
          - file_html
      days_back:
        description: 'ä½•æ—¥å‰ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‹'
        required: false
        default: '30'
        type: string

jobs:
  send-report:
    runs-on: ubuntu-latest
    environment: test
    strategy:
      matrix:
        batch: [1, 2, 3, 4]  # 4ã¤ã®ãƒãƒƒãƒã§ä¸¦åˆ—å®Ÿè¡Œï¼ˆä¿å®ˆæ€§é‡è¦–ã§ä½™è£•ã‚’æŒãŸã›ã‚‹ï¼‰
      max-parallel: 4
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Set up Python
      run: uv python install 3.12
    
    - name: Install dependencies
      run: uv sync --frozen
    
    - name: Run Multi-User Pickles analysis
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
        EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
        GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
      run: |
        # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’å–å¾—
        # å®šæœŸå®Ÿè¡Œãƒ»æ‰‹å‹•å®Ÿè¡Œã¨ã‚‚ã«çµ±åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
        # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ§‹é€ : EMAIL_TO | NOTION_API_KEY | GOOGLE_DOCS_URL | USER_NAME | LANGUAGE
        # ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å„ªå…ˆé †ä½: Notion > Google Docs
        if [[ "${{ github.event_name }}" == "schedule" ]]; then
          SPREADSHEET_ID="${{ secrets.SPREADSHEET_ID_USERS_LIST }}"
          echo "ğŸ“… å®šæœŸå®Ÿè¡Œ: çµ±åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨"
        else
          SPREADSHEET_ID="${{ github.event.inputs.spreadsheet_id || secrets.SPREADSHEET_ID_USERS_LIST }}"
          echo "ğŸ”§ æ‰‹å‹•å®Ÿè¡Œ: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID: ${SPREADSHEET_ID:0:10}..."
        fi
        
        ANALYSIS="${{ github.event.inputs.analysis_type || 'domi' }}"
        DELIVERY="${{ github.event.inputs.delivery_method || 'email_html' }}"
        DAYS="${{ github.event.inputs.days_back || '30' }}"
        
        # å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
        if [[ -z "$SPREADSHEET_ID" ]]; then
          echo "âŒ ERROR: SPREADSHEET_ID is not set in secrets"
          exit 1
        fi
        
        # å®Ÿè¡Œè¨­å®šè¡¨ç¤º
        echo "Spreadsheet ID: $SPREADSHEET_ID"
        echo "Analysis Type: $ANALYSIS"
        echo "Delivery Method: $DELIVERY"
        echo "Days Back: $DAYS"
        echo "Environment variables status:"
        echo "OPENAI_API_KEY: ${OPENAI_API_KEY:+SET}"
        echo "EMAIL_USER: ${EMAIL_USER:+SET}"
        echo "EMAIL_PASS: ${EMAIL_PASS:+SET}"
        echo "EMAIL_FROM: ${EMAIL_FROM:+SET}"
        echo "EMAIL_HOST: ${EMAIL_HOST:+SET}"
        echo "EMAIL_PORT: ${EMAIL_PORT:+SET}"
        echo "GOOGLE_SERVICE_ACCOUNT_KEY: ${GOOGLE_SERVICE_ACCOUNT_KEY:+SET}"
        
        # Google Sheetsã‹ã‚‰ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿè¡Œï¼ˆä¸¦åˆ—ãƒãƒƒãƒå‡¦ç†ï¼‰
        echo "ğŸ”„ ãƒãƒƒãƒ${{ matrix.batch }}/4 é–‹å§‹"
        uv run python read_spreadsheet_and_execute.py \
          --spreadsheet-id "$SPREADSHEET_ID" \
          --analysis "$ANALYSIS" \
          --delivery "$DELIVERY" \
          --days "$DAYS" \
          --batch-id ${{ matrix.batch }} \
          --total-batches 4