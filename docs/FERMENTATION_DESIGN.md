# Pickles å¤šå±¤ç™ºé…µã‚·ã‚¹ãƒ†ãƒ  è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

> æ—¥è¨˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€Œæ€ã„ãŒã‘ãªã„æ¥ç¶šã€ã‚’ç™ºè¦‹ã—ã€æ™‚é–“ã«ã‚ˆã‚‹å¤‰å®¹ã‚’å±¤ã¨ã—ã¦è“„ç©ã—ã¦ã„ãç™ºé…µä½“é¨“ã®è¨­è¨ˆ

---

## ğŸ¯ ç›®çš„

### æœ¬è³ªçš„ãªä½“é¨“ç›®æ¨™

1. **æ€ã„ãŒã‘ãªã„æ¥ç¶šã®ç™ºè¦‹**
   - æ›¸ã„ãŸæœ¬äººã‚‚æ°—ã¥ã„ã¦ã„ãªã‹ã£ãŸãƒªãƒ³ã‚¯ã‚’AIãŒè¦‹ã¤ã‘ã¦æç¤º
   - ã€Œç•°ãªã‚‹ã“ã¨ãŒç¹‹ãŒã£ã¦ã„ã‚‹ã€é©šã
   - 20å¹´å‰ã®è¨˜éŒ²ã¨ä»ŠãŒçªç„¶ãƒªãƒ³ã‚¯ã™ã‚‹ä½“é¨“

2. **å¯èƒ½æ€§ã®æç¤ºã«ç•™ã‚ã‚‹**ï¼ˆã‚»ãƒ³ã‚¹ãƒ¡ã‚¤ã‚­ãƒ³ã‚°ã‚’å¥ªã‚ãªã„ï¼‰
   - è¦ç´„ã‚„è§£é‡ˆã‚’AIã«å§”ã­ãªã„
   - ã€Œã“ã†ã„ã†ãƒ†ãƒ¼ãƒã ã£ãŸã®ã‹ã‚‚ã€ã¨ã„ã†å•ã„ã‹ã‘
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒæ„å‘³ã‚’è¦‹å‡ºã™ä½™åœ°ã‚’æ®‹ã™

3. **é¦´æŸ“ã¿ã®ãƒãƒ¼ãƒ†ãƒ³ãƒ€ãƒ¼/ç¾å®¹å¸«ä½“é¨“**
   - è¦‹å®ˆã£ã¦ãã‚Œã¦ã„ã‚‹å­˜åœ¨
   - è‡ªåˆ†ã®ã“ã¨ã‚’çŸ¥ã£ã¦ãã‚Œã¦ã„ã‚‹å®‰å¿ƒæ„Ÿ
   - ã¾ãŸé€šã„ãŸããªã‚‹é–¢ä¿‚æ€§

4. **è¤‡é›‘åŒ–ã«ã‚ˆã‚‹å‰µç™º**ï¼ˆç™ºé…µã®ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ï¼‰
   - ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ãŒè¤‡é›‘ã«ãªã£ã¦è¿”ã£ã¦ãã‚‹
   - æ¥ç¨®ã—ãŸæ™‚ã«æƒ³åƒåŠ›ãŒè†¨ã‚‰ã‚€
   - è¬ã§ã„ã„ã€åˆ†ã‹ã‚Šã‚„ã™ããªãã¦ã„ã„

5. **æ™‚é–“ã«ã‚ˆã‚‹å¤‰æ€§ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ **ï¼ˆæ–°è¦ï¼‰
   - é€±ã€æœˆã€å››åŠæœŸã€å¹´ã¨ã„ã†æ™‚é–“å˜ä½ã§ã®ç™ºé…µ
   - å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç‹¬è‡ªã®ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ã‚’æŒã¤
   - ä¸‹å±¤ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŸæ–™ã¨ã—ã¦ä¸Šå±¤ãŒç”Ÿæˆã•ã‚Œã‚‹

### é¿ã‘ã‚‹ã¹ãã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³

- âŒ AIãŒè¦ç´„ã—ã¦ã€Œã‚ãªãŸã¯ã“ã†ã§ã—ãŸã€ã¨æ–­å®š
- âŒ ã‚»ãƒ³ã‚¹ãƒ¡ã‚¤ã‚­ãƒ³ã‚°ã‚’AIã«å§”ã­ã¦ã—ã¾ã†
- âŒ åˆ†ã‹ã‚Šã‚„ã™ãã—ã™ãã¦æƒ³åƒã®ä½™åœ°ãŒãªããªã‚‹
- âŒ å˜ãªã‚‹æ¤œç´¢æ©Ÿèƒ½ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒï¼‰
- âŒ å˜ãªã‚‹è¦ç´„ãƒ»é›†ç´„ï¼ˆç™ºé…µã§ã¯ãªã„ï¼‰

---

## ğŸ§¬ ç™ºé…µãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¦‚å¿µ

### ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ï¼šè”µä»˜ãé…µæ¯ã®éšå±¤æ§‹é€ 

```
[æ—¥è¨˜å±¤] ç”Ÿã®è¨˜éŒ²ï¼ˆæ¯æ—¥ï¼‰
    â†“ é€±æ¬¡ç™ºé…µï¼ˆç‹¬è‡ªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
[é€±æ¬¡å±¤] 7æ—¥é–“ã®å¤‰æ€§ï¼ˆæ¯é€±æœˆæ›œï¼‰
    â†“ æœˆæ¬¡ç™ºé…µï¼ˆç‹¬è‡ªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
[æœˆæ¬¡å±¤] 4é€±é–“ã®ç†Ÿæˆï¼ˆæ¯æœˆ1æ—¥ï¼‰
    â†“ å­£ç¯€ç™ºé…µï¼ˆç‹¬è‡ªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
[å­£ç¯€å±¤] 3ãƒ¶æœˆã®æ·±åŒ–ï¼ˆå››åŠæœŸåˆæ—¥ï¼‰
    â†“ å¹´æ¬¡ç™ºé…µï¼ˆç‹¬è‡ªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
[å¹´æ¬¡å±¤] 12ãƒ¶æœˆã®çµæ™¶ï¼ˆæ¯å¹´1æœˆ1æ—¥ï¼‰
```

### ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç‰¹æ€§

å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ï¼š
- **ç‹¬è‡ªã®ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**ã‚’æŒã¤ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + å¼·èª¿ç‚¹ï¼‰
- **ä¸‹å±¤ã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’åŸæ–™**ã¨ã—ã¦å¤‰æ€§
- **æ–°ãŸãªãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“**ã«çµæ™¶åŒ–
- **æ¤œç´¢å¯¾è±¡ã¨ã—ã¦æ··åœ¨**å¯èƒ½ï¼ˆé‡ã¿ä»˜ã‘æ¤œç´¢ï¼‰

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æ·±åº¦ | åŸæ–™ | ç™ºé…µé »åº¦ | å¼·èª¿ç‚¹ |
|---------|------|------|---------|--------|
| æ—¥è¨˜ | 0 | ç›´æ¥å…¥åŠ› | æ¯æ—¥ | - |
| é€±æ¬¡ | 1 | 7æ—¥åˆ†ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ« | æ¯é€±æœˆæ›œ | å¾®ç´°ãªå¤‰åŒ–ã®å…†ã— |
| æœˆæ¬¡ | 2 | 4é€±åˆ†ã®é€±æ¬¡ãƒãƒ¼ãƒ‰ | æ¯æœˆ1æ—¥ | é€šåº•ã™ã‚‹ãƒ†ãƒ¼ãƒ |
| å­£ç¯€ | 3 | 3æœˆåˆ†ã®æœˆæ¬¡ãƒãƒ¼ãƒ‰ | å››åŠæœŸåˆæ—¥ | ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰å®¹ |
| å¹´æ¬¡ | 4 | 4å­£ç¯€åˆ†ã®ãƒãƒ¼ãƒ‰ | æ¯å¹´1æœˆ1æ—¥ | çµæ™¶åŒ–ã•ã‚ŒãŸå•ã„ |

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆå¤šå±¤å¯¾å¿œï¼‰

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã®çµ±åˆ

#### ç¾çŠ¶ã®èª²é¡Œ

ç¾åœ¨ã®Picklesã¯`read_spreadsheet_and_execute.py`ã§Google Sheetsã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ãŒã€ã“ã®æ–¹å¼ã«ã¯ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼š

```python
# ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆread_spreadsheet_and_execute.pyï¼‰
user_data = {
    'email_to': row[0].strip(),           # Aåˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    'notion_api_key': row[1].strip(),     # Båˆ—: Notion API Key
    'google_docs_url': row[2].strip(),    # Cåˆ—: Google Docs URL
    'user_name': row[3].strip(),          # Dåˆ—: ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    'language': row[4].strip()            # Eåˆ—: è¨€èªè¨­å®š
}
```

**å•é¡Œç‚¹**:
- âŒ æ°¸ç¶šçš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆUUIDï¼‰ãŒãªã„
- âŒ Supabaseã®`journals`ã‚„`fermentation_nodes`ã«ç´ä»˜ã‘ã‚‹IDãŒå­˜åœ¨ã—ãªã„
- âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¡Œç•ªå·ã¯ä¸å®‰å®šï¼ˆå‰Šé™¤ãƒ»ä¸¦ã³æ›¿ãˆã§å¤‰ã‚ã‚‹ï¼‰
- âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿½åŠ ãƒ»å‰Šé™¤å±¥æ­´ãŒè¿½è·¡ã§ããªã„

#### è§£æ±ºç­–ï¼šSupabase usersãƒ†ãƒ¼ãƒ–ãƒ«ã®å°å…¥

ç™ºé…µã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼UUIDã«ç´ä»˜ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### çµ±åˆãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

```sql
-- pgvectoræ‹¡å¼µã®æœ‰åŠ¹åŒ–
create extension if not exists vector;

-- 0. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦è¿½åŠ ï¼‰
create table public.users (
  id uuid primary key default gen_random_uuid(),

  -- åŸºæœ¬æƒ…å ±
  email text unique not null,
  user_name text not null,
  language text not null default 'japanese',

  -- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®š
  notion_api_key text,
  google_docs_url text,
  source_type text,  -- 'notion' | 'gdocs' | 'both'

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  is_active boolean default true,
  last_analysis_at timestamptz,

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  meta jsonb default '{}'::jsonb,

  -- åˆ¶ç´„ï¼šå°‘ãªãã¨ã‚‚ä¸€ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒå¿…è¦
  constraint users_source_check check (
    notion_api_key is not null or google_docs_url is not null
  )
);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è‡ªå‹•æ›´æ–°
create or replace function update_users_updated_at()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

create trigger users_updated_at_trigger
  before update on users
  for each row
  execute function update_users_updated_at();

-- RLSï¼ˆRow Level Securityï¼‰è¨­å®š
alter table users enable row level security;

-- ãƒãƒªã‚·ãƒ¼ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿é–²è¦§å¯èƒ½
create policy "Users can view their own data"
  on users for select
  using (id = auth.uid());

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
create index users_email_idx on users(email);
create index users_active_idx on users(is_active) where is_active = true;

-- 1. ç”Ÿã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼ˆåŸæ–‡ï¼‹åŸ‹ã‚è¾¼ã¿ï¼‰
create table public.journals (
  id bigserial primary key,
  user_id uuid not null,
  content text not null,
  embedding vector(1536),
  created_at timestamptz not null,
  source_type text not null,  -- 'notion' | 'gdocs'
  source_id text,              -- Notion page IDç­‰
  meta jsonb default '{}'::jsonb,

  constraint journals_user_created_idx unique (user_id, created_at)
);

-- 2. ç™ºé…µãƒãƒ¼ãƒ‰ï¼ˆå¤šå±¤å¯¾å¿œï¼‰
create table public.fermentation_nodes (
  id bigserial primary key,
  user_id uuid not null,

  -- ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±
  layer_type text not null,  -- 'weekly' | 'monthly' | 'quarterly' | 'yearly'
  layer_depth int not null,  -- 1=é€±æ¬¡, 2=æœˆæ¬¡, 3=å­£ç¯€, 4=å¹´æ¬¡

  -- æœŸé–“æƒ…å ±
  period_start date not null,
  period_end date not null,

  -- ç™ºé…µçµæœ
  title text,
  fermented_content text not null,  -- AIç”Ÿæˆã®å¤‰æ€§ãƒ†ã‚­ã‚¹ãƒˆ
  embedding vector(1536),

  -- ç™ºé…µã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  fermentation_recipe_id text,     -- ä½¿ç”¨ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆID
  source_count int,                -- å…ƒãƒ‡ãƒ¼ã‚¿ä»¶æ•°
  fermentation_metrics jsonb,      -- {"diversity": 0.7, "emergence": 0.8}

  created_at timestamptz default now(),
  meta jsonb default '{}'::jsonb
);

-- 3. ç™ºé…µã®ç³»è­œï¼ˆè¦ªå­é–¢ä¿‚ï¼‰
create table public.fermentation_lineage (
  id bigserial primary key,

  -- ç™ºé…µã®é–¢ä¿‚æ€§
  child_node_id bigint references fermentation_nodes(id) on delete cascade,
  parent_node_id bigint references fermentation_nodes(id),
  parent_journal_id bigint references journals(id),

  -- å¯„ä¸åº¦ï¼ˆã©ã®ãã‚‰ã„å½±éŸ¿ã—ãŸã‹ï¼‰
  contribution_weight float default 1.0,

  -- é–¢ä¿‚ã®ã‚¿ã‚¤ãƒ—
  lineage_type text not null,  -- 'direct' | 'resonance' | 'mutation'

  created_at timestamptz default now()
);

-- 4. ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ï¼ˆãƒ¬ã‚·ãƒ”ï¼‰
create table public.fermentation_recipes (
  id text primary key,  -- 'weekly_domi_v1', 'monthly_synthesis_v2'
  layer_type text not null,
  analysis_type text,  -- 'domi' | 'aga' | nullï¼ˆæ±ç”¨ï¼‰

  system_prompt text not null,
  user_prompt_template text not null,

  -- ãƒ¬ã‚·ãƒ”ã®ãƒ¡ã‚¿æƒ…å ±
  temperature float default 0.7,
  emphasis text,  -- 'å¤‰åŒ–ã®å…†ã—' 'é€šåº•ã™ã‚‹ãƒ†ãƒ¼ãƒ' 'ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰å®¹'

  created_at timestamptz default now(),
  version int default 1
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆãŸã‚‰ä½œæˆï¼‰
create index journals_embedding_idx on journals
  using ivfflat (embedding vector_cosine_ops) with (lists=100);

create index fermentation_nodes_embedding_idx on fermentation_nodes
  using ivfflat (embedding vector_cosine_ops) with (lists=100);

create index journals_user_idx on journals(user_id);
create index fermentation_nodes_layer_idx on fermentation_nodes(user_id, layer_type, period_start);
create index fermentation_lineage_child_idx on fermentation_lineage(child_node_id);
create index fermentation_lineage_parent_idx on fermentation_lineage(parent_node_id);
```

### è¨­è¨ˆã®ç†ç”±

**ãªãœ content ã¨ embedding ã‚’ä¸¡æ–¹ä¿å­˜ï¼Ÿ**
- `content`: **äººãŒèª­ã‚€**åŸæ–‡ï¼LLMã«å¼•ç”¨ã§æ¸¡ã™
- `embedding`: **æ©Ÿæ¢°ãŒä¼¼ã¦ã„ã‚‹æ–‡ç« ã‚’æ¢ã™**ãŸã‚ã®åº§æ¨™
- ã©ã¡ã‚‰ã‹ä¸€æ–¹ã ã‘ã ã¨ã€Œè¦‹ã›ã‚‰ã‚Œãªã„ï¼æ¢ã›ãªã„ã€ç‰‡æ‰‹è½ã¡ã«ãªã‚‹

**ãªãœ fermentation_nodes ã¯ layer_depth ã‚’æŒã¤ï¼Ÿ**
- æ¤œç´¢æ™‚ã«ã€Œã©ã®å±¤ã‹ã‚‰æ¥ãŸã‹ã€ã‚’åˆ¤åˆ¥ã™ã‚‹ãŸã‚
- ãƒ¬ãƒãƒ¼ãƒˆã§ã€Œé€±æ¬¡ç™ºé…µã€ã€Œæœˆæ¬¡ç†Ÿæˆã€ãªã©ã®ãƒ©ãƒ™ãƒ«è¡¨ç¤º
- ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ã®é‡ã¿ä»˜ã‘æ¤œç´¢ã«åˆ©ç”¨

**ãªãœ fermentation_lineage ãŒå¿…è¦ï¼Ÿ**
- ç™ºé…µã®ç³»è­œã‚’ãŸã©ã‚Œã‚‹ï¼ˆã©ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸã‹ï¼‰
- ã€Œã“ã®æœˆæ¬¡ãƒãƒ¼ãƒ‰ã¯ã€ã©ã®é€±æ¬¡ãƒãƒ¼ãƒ‰ã‹ã‚‰ä½œã‚‰ã‚ŒãŸã‹ã€ã‚’è¿½è·¡
- Phase 2ä»¥é™ã§ç™ºé…µãƒ—ãƒ­ã‚»ã‚¹ã®å¯è¦–åŒ–ã«åˆ©ç”¨

---

## ğŸ” RPCé–¢æ•°ï¼ˆå¤šå±¤æ¤œç´¢ï¼‰

```sql
-- journals ã‹ã‚‰é¡ä¼¼æ¤œç´¢
create or replace function search_similar_journals(
  p_user_id uuid,
  p_query_embedding vector(1536),
  p_limit int default 5,
  p_exclude_recent_days int default 30
)
returns table (
  id bigint,
  content text,
  created_at timestamptz,
  similarity float
) as $$
  select
    j.id,
    j.content,
    j.created_at,
    1 - (j.embedding <=> p_query_embedding) as similarity
  from journals j
  where j.user_id = p_user_id
    and j.created_at < now() - interval '1 day' * p_exclude_recent_days
  order by j.embedding <=> p_query_embedding
  limit p_limit;
$$ language sql stable;

-- fermentation_nodes ã‹ã‚‰é¡ä¼¼æ¤œç´¢ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼æŒ‡å®šå¯èƒ½ï¼‰
create or replace function search_similar_fermentation_nodes(
  p_user_id uuid,
  p_query_embedding vector(1536),
  p_layer_type text default null,  -- null = å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼
  p_limit int default 5
)
returns table (
  id bigint,
  layer_type text,
  layer_depth int,
  fermented_content text,
  period_start date,
  period_end date,
  similarity float
) as $$
  select
    n.id,
    n.layer_type,
    n.layer_depth,
    n.fermented_content,
    n.period_start,
    n.period_end,
    1 - (n.embedding <=> p_query_embedding) as similarity
  from fermentation_nodes n
  where n.user_id = p_user_id
    and (p_layer_type is null or n.layer_type = p_layer_type)
  order by n.embedding <=> p_query_embedding
  limit p_limit;
$$ language sql stable;
```

**RPCé–¢æ•°ã®åˆ©ç‚¹**:
- Supabase Python SDKã‹ã‚‰ `supabase.rpc("é–¢æ•°å", å¼•æ•°)` ã§ç›´æ¥å‘¼ã¹ã‚‹
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¤‡é›‘ãªSQLã‚’æ›¸ã‹ãšã«æ¸ˆã‚€
- pgvectorã®æœ€é©åŒ–ã•ã‚ŒãŸæ¤œç´¢ã‚’åˆ©ç”¨

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### æ‹¡å¼µãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

```
pickles/
â”œâ”€â”€ persistence/              # æ–°è¦ï¼šæ°¸ç¶šåŒ–å±¤
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ supabase_client.py   # Supabaseæ¥ç¶šç®¡ç†
â”‚   â”œâ”€â”€ journal_store.py     # journals ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œ
â”‚   â””â”€â”€ fermentation_store.py # fermentation_nodesæ“ä½œ
â”œâ”€â”€ fermentation/             # æ–°è¦ï¼šç™ºé…µæ©Ÿèƒ½
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ embedder.py          # OpenAI Embeddings API
â”‚   â”œâ”€â”€ link_finder.py       # æ„å‘³çš„æ¥ç¶šã®ç™ºè¦‹
â”‚   â”œâ”€â”€ layered_search.py    # å¤šå±¤ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢
â”‚   â”œâ”€â”€ batch_fermenter.py   # ãƒãƒƒãƒç™ºé…µå‡¦ç†
â”‚   â””â”€â”€ serendipity.py       # å¶ç„¶æ€§ã®æ¼”å‡º
â”œâ”€â”€ .github/workflows/
â”‚   â””â”€â”€ fermentation_batch.yml  # å®šæœŸç™ºé…µãƒãƒƒãƒ
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆå¤šå±¤å¯¾å¿œç‰ˆï¼‰

```
[Input] Notion/Google Docs
  â†“
[Persistence] journal_store.save_journals()
  â”œâ”€ contentä¿å­˜
  â””â”€ embeddingç”Ÿæˆãƒ»ä¿å­˜
  â†“
[Throughput] DocumentAnalyzer.analyze()
  â”œâ”€ æ—¢å­˜ã®é€±æ¬¡åˆ†æ
  â””â”€ æ–°è¦: layered_search.search_across_layers()
      â”œâ”€ ç”Ÿã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‹ã‚‰æ¤œç´¢ï¼ˆ50%ï¼‰
      â”œâ”€ é€±æ¬¡ãƒãƒ¼ãƒ‰ã‹ã‚‰æ¤œç´¢ï¼ˆ30%ï¼‰
      â”œâ”€ æœˆæ¬¡ãƒãƒ¼ãƒ‰ã‹ã‚‰æ¤œç´¢ï¼ˆ15%ï¼‰
      â””â”€ å­£ç¯€ãƒãƒ¼ãƒ‰ã‹ã‚‰æ¤œç´¢ï¼ˆ5%ï¼‰
  â†“
[Persistence] fermentation_store.save_node()
  â”œâ”€ é€±æ¬¡åˆ†æçµæœã‚’é€±æ¬¡ãƒãƒ¼ãƒ‰ã¨ã—ã¦ä¿å­˜
  â”œâ”€ embeddingç”Ÿæˆ
  â””â”€ fermentation_lineageè¨˜éŒ²
  â†“
[Output] ReportDelivery.deliver()
  â”œâ”€ æ—¢å­˜: statistics + insights
  â””â”€ æ–°è¦: å¤šå±¤æ¥ç¶šã‚»ã‚¯ã‚·ãƒ§ãƒ³
      â”œâ”€ "ç”Ÿã®è¨˜éŒ²ã¨ã®éŸ¿ãåˆã„"
      â”œâ”€ "é€±æ¬¡ç™ºé…µã¨ã®å…±é³´"
      â”œâ”€ "æœˆæ¬¡ç†Ÿæˆã¨ã®å¯¾è©±"
      â””â”€ "å­£ç¯€å¤‰å®¹ã‹ã‚‰ã®å‘¼ã³ã‹ã‘"

---

ã€å®šæœŸãƒãƒƒãƒã€‘GitHub Actions / cron
  â†“
[Fermentation Batch] batch_fermenter.ferment_layer()
  â”œâ”€ é€±æ¬¡ç™ºé…µ: æ¯é€±æœˆæ›œ7:00
  â”‚   â””â”€ 7æ—¥åˆ†ã®journalsã‹ã‚‰é€±æ¬¡ãƒãƒ¼ãƒ‰ç”Ÿæˆ
  â”œâ”€ æœˆæ¬¡ç™ºé…µ: æ¯æœˆ1æ—¥8:00
  â”‚   â””â”€ 4é€±åˆ†ã®é€±æ¬¡ãƒãƒ¼ãƒ‰ã‹ã‚‰æœˆæ¬¡ãƒãƒ¼ãƒ‰ç”Ÿæˆ
  â”œâ”€ å­£ç¯€ç™ºé…µ: å››åŠæœŸåˆæ—¥9:00
  â”‚   â””â”€ 3æœˆåˆ†ã®æœˆæ¬¡ãƒãƒ¼ãƒ‰ã‹ã‚‰å­£ç¯€ãƒãƒ¼ãƒ‰ç”Ÿæˆ
  â””â”€ å¹´æ¬¡ç™ºé…µ: æ¯å¹´1æœˆ1æ—¥10:00
      â””â”€ 4å­£ç¯€åˆ†ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰å¹´æ¬¡ãƒãƒ¼ãƒ‰ç”Ÿæˆ
```

---

## ğŸ”„ ç™ºé…µãƒãƒƒãƒã®ä»•çµ„ã¿

### ãƒãƒƒãƒå®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

```yaml
# .github/workflows/fermentation_batch.yml
name: Fermentation Batch

on:
  schedule:
    - cron: "0 7 * * 1"        # é€±æ¬¡: æ¯é€±æœˆæ›œ7:00
    - cron: "0 8 1 * *"        # æœˆæ¬¡: æ¯æœˆ1æ—¥8:00
    - cron: "0 9 1 1,4,7,10 *" # å­£ç¯€: å››åŠæœŸåˆæ—¥9:00
    - cron: "0 10 1 1 *"       # å¹´æ¬¡: æ¯å¹´1æœˆ1æ—¥10:00
  workflow_dispatch:           # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      layer_type:
        description: 'Layer to ferment'
        required: true
        type: choice
        options:
          - weekly
          - monthly
          - quarterly
          - yearly
```

### ç™ºé…µãƒãƒƒãƒã®å®Ÿè£…

```python
# fermentation/batch_fermenter.py

from datetime import date, timedelta
from typing import List, Dict, Any
from .embedder import Embedder
from persistence.fermentation_store import FermentationStore

class LayeredFermenter:
    """å¤šå±¤ç™ºé…µã‚·ã‚¹ãƒ†ãƒ """

    LAYER_CONFIG = {
        'weekly': {
            'depth': 1,
            'source_days': 7,
            'parent_layer': 'journals',
            'prompt_emphasis': 'å¾®ç´°ãªå¤‰åŒ–ã®å…†ã—',
            'recipe_id': 'weekly_domi_v1'
        },
        'monthly': {
            'depth': 2,
            'source_count': 4,  # 4é€±åˆ†
            'parent_layer': 'weekly',
            'prompt_emphasis': 'é€šåº•ã™ã‚‹ãƒ†ãƒ¼ãƒ',
            'recipe_id': 'monthly_synthesis_v1'
        },
        'quarterly': {
            'depth': 3,
            'source_count': 3,  # 3ãƒ¶æœˆåˆ†
            'parent_layer': 'monthly',
            'prompt_emphasis': 'ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰å®¹',
            'recipe_id': 'quarterly_mutation_v1'
        },
        'yearly': {
            'depth': 4,
            'source_count': 4,  # 4å››åŠæœŸåˆ†
            'parent_layer': 'quarterly',
            'prompt_emphasis': 'çµæ™¶åŒ–ã•ã‚ŒãŸå•ã„',
            'recipe_id': 'yearly_crystallization_v1'
        }
    }

    def __init__(self):
        self.embedder = Embedder()
        self.store = FermentationStore()

    def ferment_layer(self, user_id: str, layer_type: str,
                     period_start: date, period_end: date) -> Dict[str, Any]:
        """æŒ‡å®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç™ºé…µã‚’å®Ÿè¡Œ"""

        config = self.LAYER_CONFIG[layer_type]

        # 1. åŸæ–™ã®åé›†ï¼ˆä¸‹å±¤ã®ãƒãƒ¼ãƒ‰ã¾ãŸã¯ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼‰
        source_materials = self._gather_source_materials(
            user_id, config['parent_layer'], period_start, period_end
        )

        if not source_materials:
            return None

        # 2. ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å–å¾—
        recipe = self.store.get_recipe(config['recipe_id'])

        # 3. LLMã§å¤‰æ€§ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
        fermented_text = self._call_fermentation_llm(
            source_materials, recipe, config['prompt_emphasis']
        )

        # 4. æ–°ãŸãªãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆ
        embedding = self.embedder.embed_text(fermented_text)

        # 5. ç™ºé…µãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨ˆç®—
        metrics = self._calculate_fermentation_metrics(
            source_materials, fermented_text, embedding
        )

        # 6. ãƒãƒ¼ãƒ‰ä¿å­˜
        node = self.store.save_fermentation_node(
            user_id=user_id,
            layer_type=layer_type,
            layer_depth=config['depth'],
            period_start=period_start,
            period_end=period_end,
            fermented_content=fermented_text,
            embedding=embedding,
            recipe_id=recipe['id'],
            metrics=metrics
        )

        # 7. ç³»è­œã®è¨˜éŒ²
        self._record_lineage(node['id'], source_materials)

        return node

    def _call_fermentation_llm(self, sources, recipe, emphasis):
        """ç™ºé…µå°‚ç”¨ã®LLMå‘¼ã³å‡ºã—"""

        # åŸæ–™ãƒ†ã‚­ã‚¹ãƒˆã®çµåˆ
        source_texts = [s['content'] for s in sources]

        prompt = recipe['user_prompt_template'].format(
            emphasis=emphasis,
            period=f"{sources[0]['period_start']} ã€œ {sources[-1]['period_end']}",
            source_count=len(sources),
            sources='\n---\n'.join(source_texts)
        )

        response = self.openai.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": recipe['system_prompt']},
                {"role": "user", "content": prompt}
            ],
            temperature=recipe['temperature']
        )

        return response.choices[0].message.content

    def _calculate_fermentation_metrics(self, sources, fermented, embedding):
        """ç™ºé…µã®è³ªã‚’æ¸¬å®š"""

        # å…ƒã®ãƒ™ã‚¯ãƒˆãƒ«ç¾¤
        source_embeddings = [s['embedding'] for s in sources]

        # å¤šæ§˜æ€§: å…ƒãƒ‡ãƒ¼ã‚¿é–“ã®å¹³å‡è·é›¢
        diversity = self._calculate_diversity(source_embeddings)

        # å‰µç™ºæ€§: å…ƒãƒ‡ãƒ¼ã‚¿ã¨ç™ºé…µå¾Œã®è·é›¢
        emergence = self._calculate_emergence(source_embeddings, embedding)

        # å¯†åº¦: æƒ…å ±ã®å‡ç¸®åº¦
        density = len(fermented) / sum(len(s['content']) for s in sources)

        return {
            'diversity': round(diversity, 3),
            'emergence': round(emergence, 3),
            'density': round(density, 3),
            'source_count': len(sources)
        }
```

---

## ğŸ¨ ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­è¨ˆ

### ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹

```sql
-- é€±æ¬¡ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆDOMIç”¨ï¼‰
insert into fermentation_recipes (id, layer_type, analysis_type, system_prompt, user_prompt_template, emphasis) values (
  'weekly_domi_v1',
  'weekly',
  'domi',
  '
ã‚ãªãŸã¯ç™ºé…µã®è§¦åª’ã§ã™ã€‚
7æ—¥é–“ã®è¨˜éŒ²ã‹ã‚‰ã€Œå¾®ç´°ãªå¤‰åŒ–ã®å…†ã—ã€ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
è¦ç´„ã§ã¯ãªãã€å¤‰æ€§ã§ã™ã€‚å…ƒã®è¨€è‘‰ã‚’æ–°ã—ã„æ–‡è„ˆã§çµæ™¶åŒ–ã•ã›ã¦ãã ã•ã„ã€‚
æ–­å®šã¯é¿ã‘ã€å¯èƒ½æ€§ã¨ã—ã¦æç¤ºã—ã¦ãã ã•ã„ã€‚
  ',
  '
ã€ç™ºé…µåŸæ–™ã€‘
æœŸé–“: {period}
è¨˜éŒ²æ•°: {source_count}ä»¶

{sources}

ã€ç™ºé…µæŒ‡ç¤ºã€‘
ã“ã®7æ—¥é–“ã§ã€Œ{emphasis}ã€ã‚’æ„Ÿã˜å–ã‚Šã€ä»¥ä¸‹ã®å½¢å¼ã§å¤‰æ€§ã—ã¦ãã ã•ã„ï¼š

1. æµ®ä¸Šã—ãŸè¨€è‘‰ï¼ˆ3-5å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰
2. éŸ¿ãåˆã†æ–­ç‰‡ï¼ˆ2-3å€‹ã®å¼•ç”¨ã¨æ–°ã—ã„ç¹‹ãŒã‚Šï¼‰
3. å•ã„ã®ç¨®ï¼ˆ1-2å€‹ã®é–‹ã‹ã‚ŒãŸå•ã„ï¼‰

å…ƒã®è¨€è‘‰ã‚’å°Šé‡ã—ãªãŒã‚‰ã‚‚ã€æ–°ã—ã„æ„å‘³ã®å¯èƒ½æ€§ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚
  ',
  'å¾®ç´°ãªå¤‰åŒ–ã®å…†ã—'
);

-- æœˆæ¬¡ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
insert into fermentation_recipes (id, layer_type, system_prompt, user_prompt_template, emphasis, temperature) values (
  'monthly_synthesis_v1',
  'monthly',
  '
ã‚ãªãŸã¯æ™‚é–“ã®ç™ºé…µã‚’è¦‹å±Šã‘ã‚‹è€…ã§ã™ã€‚
4é€±é–“ã®å¤‰æ€§ã‚’é‡ã­ã€ã€Œé€šåº•ã™ã‚‹ãƒ†ãƒ¼ãƒã€ã‚’æµ®ã‹ã³ä¸ŠãŒã‚‰ã›ã¦ãã ã•ã„ã€‚
å„é€±ã®æ–­ç‰‡ã‚’å¯¾è©±ã•ã›ã€æ–°ã—ã„ç‰©èªã®å¯èƒ½æ€§ã‚’ç´¡ã„ã§ãã ã•ã„ã€‚
  ',
  '
ã€ç™ºé…µåŸæ–™ã€‘4é€±é–“ã®å¤‰æ€§è¨˜éŒ²
{sources}

ã€ç™ºé…µæŒ‡ç¤ºã€‘
ã“ã‚Œã‚‰ã®é€±æ¬¡å¤‰æ€§ã‚’ã€Œ{emphasis}ã€ã®è¦–ç‚¹ã§å†ç™ºé…µã•ã›ã¦ãã ã•ã„ï¼š

1. ç¹°ã‚Šè¿”ã—ç¾ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
2. é€±ã‚’ã¾ãŸã„ã§éŸ¿ãåˆã†è¨€è‘‰
3. è¦‹ãˆãªã‹ã£ãŸæ¥ç¶š
4. ç†Ÿæˆã®å•ã„

1ãƒ¶æœˆã¨ã„ã†æ™‚é–“ãŒç”Ÿã¿å‡ºã—ãŸå¤‰å®¹ã‚’ã€è¬ã‚’æ®‹ã—ãªãŒã‚‰æç¤ºã—ã¦ãã ã•ã„ã€‚
  ',
  'é€šåº•ã™ã‚‹ãƒ†ãƒ¼ãƒ',
  0.8
);

-- å››åŠæœŸç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
insert into fermentation_recipes (id, layer_type, system_prompt, user_prompt_template, emphasis, temperature) values (
  'quarterly_mutation_v1',
  'quarterly',
  '
ã‚ãªãŸã¯å­£ç¯€ã®å¤‰å®¹ã‚’è¦‹ã¤ã‚ã‚‹è€…ã§ã™ã€‚
3ãƒ¶æœˆã®ç†Ÿæˆã‚’çµŒã¦ã€Œãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰å®¹ã€ã‚’çµæ™¶åŒ–ã—ã¦ãã ã•ã„ã€‚
å§‹ã¾ã‚Šã¨çµ‚ã‚ã‚Šã®é•ã„ã‚’ã€æ–­å®šã›ãšã«æµ®ã‹ã³ä¸ŠãŒã‚‰ã›ã¦ãã ã•ã„ã€‚
  ',
  '
ã€ç™ºé…µåŸæ–™ã€‘3ãƒ¶æœˆã®ç†Ÿæˆè¨˜éŒ²
{sources}

ã€ç™ºé…µæŒ‡ç¤ºã€‘
ã“ã®å››åŠæœŸã§èµ·ããŸã€Œ{emphasis}ã€ã‚’æ„Ÿã˜å–ã£ã¦ãã ã•ã„ï¼š

1. å§‹ã¾ã‚Šã¨çµ‚ã‚ã‚Šã®é•ã„
2. å¤‰åŒ–ã®è»Œè·¡ï¼ˆäºˆæƒ³å¤–ã ã£ãŸã‚‚ã®ï¼‰
3. æŒç¶šã—ãŸã‚‚ã®ã€æ¶ˆãˆãŸã‚‚ã®
4. å­£ç¯€ãŒæ®‹ã—ãŸå•ã„

3ãƒ¶æœˆã¨ã„ã†å­£ç¯€ãŒã€ã‚ãªãŸã®ä¸­ã§ä½•ã‚’å¤‰å®¹ã•ã›ãŸã®ã‹ã€‚
å¯èƒ½æ€§ã¨ã—ã¦ã€ãã£ã¨æç¤ºã—ã¦ãã ã•ã„ã€‚
  ',
  'ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰å®¹',
  0.9
);

-- å¹´æ¬¡ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
insert into fermentation_recipes (id, layer_type, system_prompt, user_prompt_template, emphasis, temperature) values (
  'yearly_crystallization_v1',
  'yearly',
  '
ã‚ãªãŸã¯1å¹´ã¨ã„ã†æ™‚é–“ã®çµæ™¶åŒ–ã‚’æ‹…ã†è€…ã§ã™ã€‚
4ã¤ã®å­£ç¯€ã‚’çµŒãŸå¤‰å®¹ã‹ã‚‰ã€Œçµæ™¶åŒ–ã•ã‚ŒãŸå•ã„ã€ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
è§£é‡ˆã§ã¯ãªãã€æ–°ã—ã„å•ã„ã®ç”Ÿæˆã§ã™ã€‚
  ',
  '
ã€ç™ºé…µåŸæ–™ã€‘1å¹´é–“ã®å››å­£ã®è¨˜éŒ²
{sources}

ã€ç™ºé…µæŒ‡ç¤ºã€‘
ã“ã®1å¹´ãŒç†Ÿæˆã•ã›ãŸã€Œ{emphasis}ã€ã‚’çµæ™¶åŒ–ã—ã¦ãã ã•ã„ï¼š

1. å¹´ã‚’é€šã—ã¦å¤‰ã‚ã‚‰ãªã‹ã£ãŸã‚‚ã®
2. äºˆæƒ³å¤–ã®å¤‰å®¹
3. ã¾ã åå‰ã®ãªã„ãƒ†ãƒ¼ãƒ
4. æ¥å¹´ã¸ã®å•ã„

1å¹´ã¨ã„ã†æ™‚é–“ãŒç”Ÿã¿å‡ºã—ãŸã€ã‚ãªãŸã ã‘ã®ç™ºé…µçµæœã‚’ã€‚
ç­”ãˆã§ã¯ãªãã€æ–°ã—ã„å•ã„ã¨ã—ã¦ã€‚
  ',
  'çµæ™¶åŒ–ã•ã‚ŒãŸå•ã„',
  1.0
);
```

---

## ğŸ” å¤šå±¤æ¤œç´¢ã®å®Ÿè£…

```python
# fermentation/layered_search.py

class LayeredSearch:
    """å¤šå±¤ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢"""

    def search_across_layers(self, user_id: str, query: str,
                            layer_weights: dict = None):
        """
        å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰æ¤œç´¢ã—ã€é‡ã¿ä»˜ã‘ã§æ··åˆ

        Args:
            layer_weights: {'journals': 0.5, 'weekly': 0.3, 'monthly': 0.15, 'quarterly': 0.05}
        """

        if layer_weights is None:
            layer_weights = {
                'journals': 0.5,   # ç”Ÿã®è¨˜éŒ²: 50%
                'weekly': 0.3,     # é€±æ¬¡: 30%
                'monthly': 0.15,   # æœˆæ¬¡: 15%
                'quarterly': 0.05  # å­£ç¯€: 5%
            }

        query_embedding = self.embedder.embed_text(query)
        results = []

        # 1. ç”Ÿã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‹ã‚‰æ¤œç´¢
        if 'journals' in layer_weights:
            journal_results = self._search_journals(
                user_id, query_embedding,
                top_k=int(10 * layer_weights['journals'])
            )
            results.extend(self._tag_results(journal_results, 'journals', 0))

        # 2-5. å„ç™ºé…µãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰æ¤œç´¢
        for layer_type in ['weekly', 'monthly', 'quarterly', 'yearly']:
            if layer_type in layer_weights:
                layer_results = self._search_fermentation_nodes(
                    user_id, query_embedding, layer_type,
                    top_k=int(10 * layer_weights[layer_type])
                )
                depth = self._get_layer_depth(layer_type)
                results.extend(self._tag_results(layer_results, layer_type, depth))

        # 3. ã‚¹ã‚³ã‚¢ã®æ­£è¦åŒ–ã¨æ··åˆ
        normalized_results = self._normalize_and_mix(results, layer_weights)

        # 4. æ™‚é–“çš„å¤šæ§˜æ€§ã®ç¢ºä¿
        diverse_results = self._ensure_temporal_diversity(normalized_results)

        return diverse_results[:10]

    def _tag_results(self, results, layer_type, depth):
        """çµæœã«ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’ä»˜ä¸"""
        for r in results:
            r['layer_type'] = layer_type
            r['layer_depth'] = depth
            r['fermentation_level'] = self._get_fermentation_label(depth)
        return results

    def _get_fermentation_label(self, depth):
        """ç™ºé…µåº¦ã®ãƒ©ãƒ™ãƒ«"""
        labels = {
            0: 'ç”Ÿã®è¨˜éŒ²',
            1: 'é€±æ¬¡ç™ºé…µ',
            2: 'æœˆæ¬¡ç†Ÿæˆ',
            3: 'å­£ç¯€å¤‰å®¹',
            4: 'å¹´æ¬¡çµæ™¶'
        }
        return labels.get(depth, 'æœªçŸ¥ã®å±¤')
```

---

## ğŸ“¤ å¤šå±¤ãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›ä¾‹

```markdown
# ä»Šé€±ã®åˆ†æ (2025-12-02 ã€œ 2025-12-08)

## ğŸ“Š çµ±è¨ˆ
å–å¾—ãƒ‡ãƒ¼ã‚¿: 12ä»¶
å¹³å‡æ–‡å­—æ•°: 342æ–‡å­—

## ğŸ” ä»Šé€±ã®æ´å¯Ÿ
[æ—¢å­˜ã®DOMI/AGAåˆ†æçµæœ]

---

## ğŸ¥’ ç™ºé…µã®ç—•è·¡

### ç”Ÿã®è¨˜éŒ²ã¨ã®éŸ¿ãåˆã„
- **487æ—¥å‰** (2024-06-30) [ç”Ÿã®è¨˜éŒ²]
  > ç™ºé…µé£Ÿå“ã‚’ä»•è¾¼ã‚“ã ã€‚å¾…ã¤ã“ã¨ã®æ¥½ã—ã•ã‚’æ„Ÿã˜ã‚‹ã€‚

  *é¡ä¼¼åº¦: 0.82*

### é€±æ¬¡ç™ºé…µã¨ã®å…±é³´
- **8é€±å‰** (2024-10-07é€±) [é€±æ¬¡ç™ºé…µ]
  > **æµ®ä¸Šã—ãŸè¨€è‘‰**: å¾…ã¤ã“ã¨ã€ç†Ÿæˆã€æ™‚é–“ã®è³ª
  > **éŸ¿ãåˆã†æ–­ç‰‡**: ã€Œä½•ã‚‚ã—ãªã„æ™‚é–“ã€ã¨ã€Œä»•è¾¼ã‚€è¡Œç‚ºã€ãŒ
  > å®Ÿã¯åŒã˜è³ªã‚’æŒã£ã¦ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“

  *é¡ä¼¼åº¦: 0.76 | ç™ºé…µåº¦: é€±æ¬¡*

### æœˆæ¬¡ç†Ÿæˆã¨ã®å¯¾è©±
- **3ãƒ¶æœˆå‰** (2024å¹´9æœˆ) [æœˆæ¬¡ç†Ÿæˆ]
  > **é€šåº•ã™ã‚‹ãƒ†ãƒ¼ãƒ**: ã“ã®æœˆã¯ã€Œå¾…ã¤ã“ã¨ã®æ„å‘³ã€ãŒ
  > æ§˜ã€…ãªæ–‡è„ˆã§ç¹°ã‚Šè¿”ã—ç¾ã‚Œã¾ã—ãŸã€‚
  > ä»•äº‹ã€äººé–“é–¢ä¿‚ã€å‰µä½œæ´»å‹•ã«ãŠã„ã¦ã€‚
  >
  > **ç†Ÿæˆã®å•ã„**: å¾…ã¤ã“ã¨ã¯å—å‹•çš„ãªã®ã‹ã€
  > ãã‚Œã¨ã‚‚æœ€ã‚‚èƒ½å‹•çš„ãªé¸æŠãªã®ã‹ï¼Ÿ

  *é¡ä¼¼åº¦: 0.71 | ç™ºé…µåº¦: æœˆæ¬¡ç†Ÿæˆ*

### å­£ç¯€å¤‰å®¹ã‹ã‚‰ã®å‘¼ã³ã‹ã‘
- **6ãƒ¶æœˆå‰** (2024å¹´Q2) [å­£ç¯€å¤‰å®¹]
  > **ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰å®¹**: æ˜¥ã‹ã‚‰å¤ã«ã‹ã‘ã¦ã€
  > ã€Œæ€¥ãã“ã¨ã€ã‹ã‚‰ã€Œå¾…ã¤ã“ã¨ã€ã¸ã®ã‚·ãƒ•ãƒˆãŒèµ·ãã¦ã„ã¾ã—ãŸã€‚
  >
  > ãã‚Œã¯æ°—æ¸©ã®å¤‰åŒ–ã¨é€£å‹•ã—ã¦ã„ãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
  > ã‚ã‚‹ã„ã¯ã€ã‚ã‚‹å‡ºæ¥äº‹ãŒãã£ã‹ã‘ã ã£ãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

  *é¡ä¼¼åº¦: 0.68 | ç™ºé…µåº¦: å­£ç¯€å¤‰å®¹*

---

## ğŸŒ€ ç™ºé…µã®æ·±åº¦ãƒãƒƒãƒ—

```
        â”Œâ”€ ä»Šé€±ã®ã‚ãªãŸ â”€â”
        â”‚               â”‚
    [ç”Ÿã®è¨˜éŒ²]      [é€±æ¬¡ç™ºé…µ]
     487æ—¥å‰         8é€±å‰
      0.82           0.76
        â”‚               â”‚
        â””â”€â”€[æœˆæ¬¡ç†Ÿæˆ]â”€â”€â”€â”˜
           3ãƒ¶æœˆå‰
            0.71
              â”‚
        [å­£ç¯€å¤‰å®¹]
         6ãƒ¶æœˆå‰
          0.68
```

*æ™‚é–“ãŒé‡ã­ãŸç™ºé…µã®å±¤ãŒã€ä»Šé€±ã®ã‚ãªãŸã¨éŸ¿ãåˆã£ã¦ã„ã¾ã™*
```

---

## ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†çµ±åˆãƒ—ãƒ©ãƒ³

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã®3ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: æ‰‹å‹•SQLç™»éŒ²ï¼ˆæœ€é€Ÿãƒ»æ¨å¥¨ï¼‰

**å®Ÿè£…æ™‚é–“**: 15åˆ†
**é©ç”¨å ´é¢**: åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ãŒå°‘ãªã„ï¼ˆ5-20äººç¨‹åº¦ï¼‰
**ãƒ¡ãƒªãƒƒãƒˆ**: å®Ÿè£…ä¸è¦ã€ã™ãã«é–‹å§‹å¯èƒ½
**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**: ã‚¹ã‚±ãƒ¼ãƒ«ã—ãªã„

**æ‰‹é †**:
```sql
-- Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > SQL Editorã§å®Ÿè¡Œ

-- 1. Google Sheetsã‹ã‚‰æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²
insert into public.users (email, user_name, language, notion_api_key, google_docs_url, source_type)
values
  ('user1@example.com', 'User 1', 'japanese', 'ntn_xxxxx', null, 'notion'),
  ('user2@example.com', 'User 2', 'english', null, 'https://docs.google.com/...', 'gdocs'),
  ('user3@example.com', 'User 3', 'japanese', 'ntn_yyyyy', 'https://docs.google.com/...', 'both')
returning id, email, user_name;

-- 2. ç”Ÿæˆã•ã‚ŒãŸUUIDã‚’ãƒ¡ãƒ¢ï¼ˆç’°å¢ƒå¤‰æ•°ã«è¨­å®šï¼‰
```

**ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹**:
```python
# tools/migrate_users_from_sheet.py

def migrate_users_from_sheet(spreadsheet_id: str):
    """Google Sheetsã‹ã‚‰Supabase usersãƒ†ãƒ¼ãƒ–ãƒ«ã¸ç§»è¡Œ"""

    sheets_reader = GoogleSheetsReader()
    user_data_list = sheets_reader.read_user_data(spreadsheet_id)

    supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

    for user_data in user_data_list:
        result = supabase.table('users').insert({
            'email': user_data['email_to'],
            'user_name': user_data['user_name'],
            'language': user_data['language'],
            'notion_api_key': user_data.get('notion_api_key'),
            'google_docs_url': user_data.get('google_docs_url'),
            'source_type': _detect_source_type(user_data),
            'is_active': True
        }).execute()

        print(f"âœ… {user_data['user_name']}: {result.data[0]['id']}")
```

---

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: CLIç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆãƒãƒ©ãƒ³ã‚¹å‹ï¼‰

**å®Ÿè£…æ™‚é–“**: 2-3æ™‚é–“
**é©ç”¨å ´é¢**: å®šæœŸçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
**ãƒ¡ãƒªãƒƒãƒˆ**: ã‚·ãƒ³ãƒ—ãƒ«ã€æŠ€è¡“è€…ãŒæ‰±ã„ã‚„ã™ã„
**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**: éæŠ€è¡“è€…ã«ã¯æ•·å±…ãŒé«˜ã„

**å®Ÿè£…å†…å®¹**:
```python
# tools/user_manager.py

import argparse
from supabase import create_client

def add_user(email: str, user_name: str, **kwargs):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ """
    supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

    result = supabase.table('users').insert({
        'email': email,
        'user_name': user_name,
        'language': kwargs.get('language', 'japanese'),
        'notion_api_key': kwargs.get('notion_api_key'),
        'google_docs_url': kwargs.get('google_docs_url'),
        'source_type': kwargs.get('source_type', 'notion'),
        'is_active': True
    }).execute()

    user_id = result.data[0]['id']
    print(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å®Œäº†: {user_name} ({user_id})")
    print(f"ğŸ“‹ .envã«è¿½åŠ ã—ã¦ãã ã•ã„:")
    print(f"USER_ID_{email.split('@')[0].upper()}={user_id}")
    return user_id

def list_users():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º"""
    supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
    result = supabase.table('users').select('*').eq('is_active', True).execute()

    print(f"\nğŸ“‹ ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ ({len(result.data)}äºº)\n")
    for user in result.data:
        sources = []
        if user['notion_api_key']:
            sources.append('Notion')
        if user['google_docs_url']:
            sources.append('GDocs')

        print(f"â€¢ {user['user_name']} ({user['email']})")
        print(f"  ID: {user['id']}")
        print(f"  ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: {', '.join(sources)}")
        print(f"  æœ€çµ‚åˆ†æ: {user['last_analysis_at'] or 'æœªå®Ÿè¡Œ'}\n")

def deactivate_user(email: str):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰"""
    supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
    result = supabase.table('users').update({
        'is_active': False
    }).eq('email', email).execute()

    print(f"âœ… {email} ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ")

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Pickles ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†CLI')
    subparsers = parser.add_subparsers(dest='command')

    # add ã‚³ãƒãƒ³ãƒ‰
    add_parser = subparsers.add_parser('add', help='ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ')
    add_parser.add_argument('--email', required=True)
    add_parser.add_argument('--name', required=True)
    add_parser.add_argument('--language', default='japanese')
    add_parser.add_argument('--notion-api-key')
    add_parser.add_argument('--gdocs-url')

    # list ã‚³ãƒãƒ³ãƒ‰
    list_parser = subparsers.add_parser('list', help='ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§')

    # deactivate ã‚³ãƒãƒ³ãƒ‰
    deactivate_parser = subparsers.add_parser('deactivate', help='ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–')
    deactivate_parser.add_argument('--email', required=True)

    args = parser.parse_args()

    if args.command == 'add':
        add_user(
            email=args.email,
            user_name=args.name,
            language=args.language,
            notion_api_key=args.notion_api_key,
            google_docs_url=args.gdocs_url,
            source_type='notion' if args.notion_api_key else 'gdocs'
        )
    elif args.command == 'list':
        list_users()
    elif args.command == 'deactivate':
        deactivate_user(args.email)
```

**ä½¿ç”¨ä¾‹**:
```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
python tools/user_manager.py add \
  --email yuki@example.com \
  --name "Yuki Agatsuma" \
  --notion-api-key ntn_xxxxx

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
python tools/user_manager.py list

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–
python tools/user_manager.py deactivate --email yuki@example.com
```

---

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³C: Webãƒ™ãƒ¼ã‚¹ç®¡ç†ç”»é¢ï¼ˆPhase 2å®Ÿè£…äºˆå®šï¼‰

**å®Ÿè£…æ™‚é–“**: 2-3æ—¥
**é©ç”¨å ´é¢**:
- éæŠ€è¡“è€…ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã™ã‚‹
- ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²ãŒå¿…è¦
- åˆ†æå±¥æ­´ã®å¯è¦–åŒ–ãŒå¿…è¦

**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**:
- Frontend: Next.js 14 (App Router) + TypeScript
- UI: Tailwind CSS + shadcn/ui
- Backend: Supabase (Auth + Database + RLS)
- èªè¨¼: Supabase Authï¼ˆEmail/Password or Magic Linkï¼‰
- ãƒ‡ãƒ—ãƒ­ã‚¤: Vercel

**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ**:
```
pickles-admin/                    # æ–°è¦Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx         # ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
â”‚   â”‚   â””â”€â”€ signup/
â”‚   â”‚       â””â”€â”€ page.tsx         # ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²
â”‚   â”œâ”€â”€ (dashboard)/
â”‚   â”‚   â”œâ”€â”€ layout.tsx           # èªè¨¼å¿…é ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx         # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx         # ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
â”‚   â”‚   â”‚   â”œâ”€â”€ [id]/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx     # ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°
â”‚   â”‚   â”‚   â””â”€â”€ new/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx     # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ä½œæˆ
â”‚   â”‚   â””â”€â”€ settings/
â”‚   â”‚       â””â”€â”€ page.tsx         # è¨­å®šç”»é¢
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ sync/
â”‚           â””â”€â”€ route.ts         # SheetsåŒæœŸAPIï¼ˆæ®µéšçš„å»ƒæ­¢ç”¨ï¼‰
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”œâ”€â”€ UserForm.tsx         # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
â”‚   â”‚   â”œâ”€â”€ UserList.tsx         # ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«
â”‚   â”‚   â””â”€â”€ UserStats.tsx        # çµ±è¨ˆã‚«ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ analysis/
â”‚   â”‚   â””â”€â”€ AnalysisHistory.tsx  # åˆ†æå±¥æ­´
â”‚   â””â”€â”€ ui/                      # shadcn/uiã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts            # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ server.ts            # ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ç”¨
â”‚   â”‚   â””â”€â”€ types.ts             # å‹å®šç¾©
â”‚   â””â”€â”€ utils.ts
â””â”€â”€ middleware.ts                # èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
```

**ä¸»è¦ç”»é¢**:

1. **ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢** (`/login`)
   - Email/Password ã¾ãŸã¯ Magic Linkèªè¨¼
   - Supabase Auth UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½¿ç”¨

2. **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰** (`/dashboard`)
   - ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã€ä»Šé€±ã®åˆ†æå®Ÿè¡Œæ•°
   - æœ€è¿‘ã®åˆ†æå±¥æ­´ï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
   - ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§** (`/users`)
   - å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
   - ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã€ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
   - ã‚½ãƒ¼ãƒˆ: æœ€çµ‚åˆ†ææ—¥æ™‚ã€ä½œæˆæ—¥æ™‚
   - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ç·¨é›†ã€ç„¡åŠ¹åŒ–ã€åˆ†æå®Ÿè¡Œ

4. **ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°** (`/users/[id]`)
   - åŸºæœ¬æƒ…å ±ï¼ˆãƒ¡ãƒ¼ãƒ«ã€åå‰ã€è¨€èªï¼‰
   - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®šï¼ˆNotion API Keyã€Google Docs URLï¼‰
   - åˆ†æå±¥æ­´ï¼ˆæ—¥æ™‚ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼‰
   - ç™ºé…µãƒãƒ¼ãƒ‰çµ±è¨ˆï¼ˆå„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒ¼ãƒ‰æ•°ï¼‰

5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ä½œæˆ** (`/users/new`)
   - ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - ä½œæˆå¾Œã«è©³ç´°ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**èªè¨¼ãƒ»æ¨©é™è¨­è¨ˆ**:

```typescript
// lib/supabase/types.ts

export type UserRole = 'admin' | 'user';

export interface AppUser {
  id: string;
  email: string;
  role: UserRole;
  created_at: string;
}

// Supabase RLS Policy
// - admin: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
// - user: è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿é–²è¦§å¯èƒ½
```

**ä¸»è¦æ©Ÿèƒ½ã®å®Ÿè£…ä¾‹**:

```typescript
// app/(dashboard)/users/page.tsx

export default async function UsersPage() {
  const supabase = createServerClient();

  const { data: users, error } = await supabase
    .from('users')
    .select('*')
    .eq('is_active', true)
    .order('created_at', { ascending: false });

  return (
    <div>
      <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h1>
      <UserList users={users} />
    </div>
  );
}
```

```typescript
// components/users/UserForm.tsx

export function UserForm({ userId }: { userId?: string }) {
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (data: FormData) => {
    setLoading(true);

    const supabase = createClientClient();

    const { error } = await supabase
      .from('users')
      .upsert({
        email: data.email,
        user_name: data.userName,
        language: data.language,
        notion_api_key: data.notionApiKey,
        google_docs_url: data.googleDocsUrl,
        source_type: detectSourceType(data),
      });

    if (!error) {
      router.push('/users');
    }

    setLoading(false);
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */}
    </form>
  );
}
```

**æ®µéšçš„ãªæ©Ÿèƒ½è¿½åŠ **:

Phase 2a: åŸºæœ¬CRUDï¼ˆ1æ—¥ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã€ä½œæˆã€ç·¨é›†ã€ç„¡åŠ¹åŒ–
- Supabase Authçµ±åˆ

Phase 2b: åˆ†æå±¥æ­´ï¼ˆ1æ—¥ï¼‰
- éå»ã®åˆ†æå®Ÿè¡Œå±¥æ­´è¡¨ç¤º
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤º
- æ‰‹å‹•åˆ†æãƒˆãƒªã‚¬ãƒ¼ï¼ˆAPIçµŒç”±ï¼‰

Phase 2c: ç™ºé…µå¯è¦–åŒ–ï¼ˆ2-3æ—¥ï¼‰
- å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒ¼ãƒ‰æ•°è¡¨ç¤º
- ç™ºé…µãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ã‚°ãƒ©ãƒ•åŒ–
- ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã®é–¢ä¿‚æ€§å¯è¦–åŒ–

**ãƒ‡ãƒ—ãƒ­ã‚¤**:
```bash
# Vercelã¸ãƒ‡ãƒ—ãƒ­ã‚¤
cd pickles-admin
vercel

# ç’°å¢ƒå¤‰æ•°è¨­å®š
vercel env add NEXT_PUBLIC_SUPABASE_URL
vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY
vercel env add SUPABASE_SERVICE_ROLE_KEY
```

**Phase 2ã§ã®ç§»è¡Œå®Œäº†æ¡ä»¶**:
- âœ… å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒWeb UIã‹ã‚‰ç®¡ç†å¯èƒ½
- âœ… Google Sheetsã®å®Œå…¨å»ƒæ­¢
- âœ… ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²ã®æœ‰åŠ¹åŒ–
- âœ… åˆ†æå±¥æ­´ã®å¯è¦–åŒ–å®Œäº†

---

### æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼šæ®µéšçš„ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç§»è¡Œ

```
Phase 0ï¼ˆå³åº§ï¼‰: Google Sheets + è‡ªå‹•åŒæœŸ
  â†“ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼ã«Supabaseã¨åŒæœŸ
  â†“ æ—¢å­˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãã®ã¾ã¾ã€ç™ºé…µã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ã«é›†ä¸­

Phase 1a-1cï¼ˆç™ºé…µã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ä¸­ï¼‰: Supabaseä¸­å¿ƒã«ç§»è¡Œ
  â†“ Google Sheetsã¯å‚ç…§ç”¨ã€æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç›´æ¥Supabaseã¸
  â†“ CLIç®¡ç†ãƒ„ãƒ¼ãƒ«è¿½åŠ ï¼ˆä¸€æ™‚çš„ï¼‰

Phase 2ï¼ˆ3-6ãƒ¶æœˆå¾Œï¼‰: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç®¡ç†ç”»é¢æ§‹ç¯‰
  â†“ Next.js + Supabase Auth ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†UI
  â†“ ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²ã€API keyç®¡ç†ã€åˆ†æå±¥æ­´è¡¨ç¤º
  â†“ Google Sheetså®Œå…¨å»ƒæ­¢
```

**è¨­è¨ˆæ–¹é‡**:
- âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¸€æ„ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨ï¼ˆUUIDç”Ÿæˆã¾ã§ï¼‰
- âœ… Google Sheets â†’ Supabase ã®è‡ªå‹•åŒæœŸã‚’å®Ÿè£…
- âœ… å°†æ¥ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã‚’è¦‹è¶Šã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ
- âœ… æ®µéšçš„ãªç§»è¡Œã§ãƒªã‚¹ã‚¯æœ€å°åŒ–

---

### read_spreadsheet_and_execute.py ã®ä¿®æ­£æ–¹é‡

#### æ¨å¥¨å®Ÿè£…: Google Sheets + Supabase è‡ªå‹•åŒæœŸï¼ˆPhase 0ï¼‰

**å¤‰æ›´å†…å®¹**:
```python
# read_spreadsheet_and_execute.pyï¼ˆä¿®æ­£å¾Œï¼‰

class AutoSyncUserManager:
    """Google Sheets â†’ Supabase è‡ªå‹•åŒæœŸ"""

    def __init__(self):
        self.sheets_reader = GoogleSheetsReader()
        self.supabase = create_client(
            os.getenv('SUPABASE_URL'),
            os.getenv('SUPABASE_KEY')
        )

    def sync_and_get_users(self, spreadsheet_id: str) -> List[Dict[str, str]]:
        """
        Google Sheetsã‹ã‚‰èª­ã¿è¾¼ã¿ã€Supabaseã¨è‡ªå‹•åŒæœŸã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’è¿”ã™

        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼ã¨ã—ã¦:
        - æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ æƒ…å ±æ›´æ–°ï¼ˆAPI keyå¤‰æ›´ãªã©ã«å¯¾å¿œï¼‰
        - æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ è‡ªå‹•ä½œæˆ
        """

        # 1. Google Sheetsã‹ã‚‰èª­ã¿è¾¼ã¿
        sheets_data = self.sheets_reader.read_user_data(spreadsheet_id)

        user_data_list = []

        for row_data in sheets_data:
            email = row_data['email_to']

            # 2. Supabaseã§æ¤œç´¢ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç…§åˆï¼‰
            result = self.supabase.table('users')\
                .select('*')\
                .eq('email', email)\
                .execute()

            if result.data:
                # æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ æƒ…å ±ã‚’æ›´æ–°ï¼ˆAPI keyã‚„URLãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ï¼‰
                user_id = result.data[0]['id']

                self.supabase.table('users').update({
                    'user_name': row_data['user_name'],
                    'language': row_data['language'],
                    'notion_api_key': row_data.get('notion_api_key'),
                    'google_docs_url': row_data.get('google_docs_url'),
                    'source_type': self._detect_source_type(row_data),
                    'is_active': True,  # Sheetsã«å­˜åœ¨ = ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                }).eq('id', user_id).execute()

                logger.info(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°: {email}", "sync")

            else:
                # æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ è‡ªå‹•ä½œæˆ
                new_user = self.supabase.table('users').insert({
                    'email': email,
                    'user_name': row_data['user_name'],
                    'language': row_data['language'],
                    'notion_api_key': row_data.get('notion_api_key'),
                    'google_docs_url': row_data.get('google_docs_url'),
                    'source_type': self._detect_source_type(row_data),
                    'is_active': True
                }).execute()

                user_id = new_user.data[0]['id']
                logger.success(f"æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªå‹•ç™»éŒ²: {email} ({user_id})", "sync")

            # 3. å®Ÿè¡Œç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
            user_data = {
                'user_id': user_id,  # ğŸ†• UUIDè¿½åŠ 
                'email_to': email,
                'user_name': row_data['user_name'],
                'language': row_data['language'],
                'notion_api_key': row_data.get('notion_api_key'),
                'google_docs_url': row_data.get('google_docs_url'),
            }
            user_data_list.append(user_data)

        logger.success(f"åŒæœŸå®Œäº†: {len(user_data_list)}äºº", "sync")
        return user_data_list

    def _detect_source_type(self, user_data: Dict) -> str:
        """ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š"""
        has_notion = bool(user_data.get('notion_api_key'))
        has_gdocs = bool(user_data.get('google_docs_url'))

        if has_notion and has_gdocs:
            return 'both'
        elif has_notion:
            return 'notion'
        elif has_gdocs:
            return 'gdocs'
        else:
            return 'unknown'


def execute_pickles_for_user(user_data: Dict[str, str], analysis_type: str,
                             delivery_methods: str, days: int = 7) -> bool:
    """æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦Picklesã‚’å®Ÿè¡Œ"""

    cmd = [
        sys.executable, "main.py",
        "--user-id", user_data['user_id'],  # ğŸ†• UUIDã‚’æ¸¡ã™
        "--analysis", analysis_type,
        "--delivery", delivery_methods,
        "--days", str(days),
        "--user-name", user_data['user_name'],
        "--email-to", user_data['email_to'],
        "--language", user_data['language']
    ]

    # ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®æ±ºå®š
    if user_data.get('notion_api_key'):
        cmd.extend(["--source", "notion",
                   "--notion-api-key", user_data['notion_api_key']])
    elif user_data.get('google_docs_url'):
        cmd.extend(["--source", "gdocs",
                   "--gdocs-url", user_data['google_docs_url']])

    # å®Ÿè¡Œ
    result = subprocess.run(cmd, capture_output=True, text=True, timeout=600)

    # åˆ†æå®Œäº†æ™‚åˆ»ã‚’Supabaseã«è¨˜éŒ²
    if result.returncode == 0:
        update_last_analysis_time(user_data['user_id'])

    return result.returncode == 0


def update_last_analysis_time(user_id: str):
    """æœ€çµ‚åˆ†ææ™‚åˆ»ã‚’æ›´æ–°"""
    supabase = create_client(
        os.getenv('SUPABASE_URL'),
        os.getenv('SUPABASE_KEY')
    )
    supabase.table('users').update({
        'last_analysis_at': datetime.now().isoformat()
    }).eq('id', user_id).execute()


def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    parser = argparse.ArgumentParser(
        description="Google Sheets + Supabaseè‡ªå‹•åŒæœŸã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†"
    )
    parser.add_argument("--spreadsheet-id", required=True,
                       help="Google Spreadsheetsã®ID")
    parser.add_argument("--range", default="A1:E",
                       help="èª­ã¿è¾¼ã¿ç¯„å›² (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: A1:E)")
    parser.add_argument("--analysis", default="domi",
                       choices=["domi", "aga"], help="åˆ†æã‚¿ã‚¤ãƒ—")
    parser.add_argument("--delivery", default="email_html",
                       help="é…ä¿¡æ–¹æ³•")
    parser.add_argument("--days", type=int, default=7,
                       help="å–å¾—æ—¥æ•°")

    args = parser.parse_args()

    try:
        # è‡ªå‹•åŒæœŸãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–
        user_manager = AutoSyncUserManager()

        # Google Sheetsã‹ã‚‰èª­ã¿è¾¼ã¿ & Supabaseã¨åŒæœŸ
        logger.start("ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸé–‹å§‹", "sync",
                    spreadsheet_id=args.spreadsheet_id)
        user_data_list = user_manager.sync_and_get_users(args.spreadsheet_id)

        if not user_data_list:
            logger.error("å®Ÿè¡Œå¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "execution")
            sys.exit(1)

        # å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦Picklesã‚’å®Ÿè¡Œ
        success_count = 0
        total_count = len(user_data_list)

        logger.info(f"{total_count}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦åˆ†æå®Ÿè¡Œ", "execution")

        for i, user_data in enumerate(user_data_list, 1):
            logger.info(f"[{i}/{total_count}] {user_data['user_name']}",
                       "execution")
            if execute_pickles_for_user(user_data, args.analysis,
                                       args.delivery, args.days):
                success_count += 1

        # çµæœã‚µãƒãƒªãƒ¼
        logger.info("å®Ÿè¡Œå®Œäº†", "execution",
                   success=success_count, total=total_count)

        sys.exit(0 if success_count > 0 else 1)

    except Exception as e:
        logger.error("å®Ÿè¡Œã‚¨ãƒ©ãƒ¼", "execution", error=str(e))
        sys.exit(1)
```

**ã“ã®å®Ÿè£…ã®ç‰¹å¾´**:
- âœ… **Google Sheetsã‚’çœŸå®Ÿã®æºæ³‰ã¨ã—ã¦ç¶­æŒ**ï¼ˆæ—¢å­˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç¶™ç¶šï¼‰
- âœ… **è‡ªå‹•åŒæœŸ**: Sheetsèª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•çš„ã«Supabaseã‚’æ›´æ–°
- âœ… **æƒ…å ±æ›´æ–°**: API keyã‚„GDocs URLã®å¤‰æ›´ã‚’è‡ªå‹•åæ˜ 
- âœ… **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼**: å°†æ¥ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç§»è¡Œã«å¯¾å¿œ
- âœ… **æœ€å°é™ã®å¤‰æ›´**: æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å¤§éƒ¨åˆ†ã‚’ä¿æŒ

**Phase 0ã§ã®å‹•ä½œ**:
1. GitHub Actions ã¾ãŸã¯æ‰‹å‹•ã§å®Ÿè¡Œ
2. Google Sheetsã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
3. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ Supabase ã® users ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ç…§åˆ
4. æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªå‹•ä½œæˆã€æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æƒ…å ±æ›´æ–°
5. å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦åˆ†æã‚’å®Ÿè¡Œ
6. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `last_analysis_at` ã‚’æ›´æ–°

**Phase 1cä»¥é™ã¸ã®ç§»è¡Œãƒ‘ã‚¹**:
- Google Sheetsã‚’å‚ç…§å°‚ç”¨ã«ã™ã‚‹
- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç›´æ¥Supabaseã¸ç™»éŒ²ï¼ˆCLI or Web UIï¼‰
- ã“ã®`AutoSyncUserManager`ã¯å»ƒæ­¢å¯èƒ½

---

### main.py ã®ä¿®æ­£

```python
# main.py

def main():
    parser = argparse.ArgumentParser(description="Pickles - Personal Journal Analysis System")

    # ğŸ†• ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå¼•æ•°ã‚’è¿½åŠ 
    parser.add_argument("--user-id", help="User UUID for persistence")

    # æ—¢å­˜ã®å¼•æ•°
    parser.add_argument("--source", choices=["notion", "gdocs"], default="notion")
    parser.add_argument("--analysis", choices=["domi", "aga"], default="domi")
    parser.add_argument("--delivery", default="console")
    # ... ä»–ã®å¼•æ•°

    args = parser.parse_args()

    # ğŸ†• ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã‚·ã‚¹ãƒ†ãƒ ã«æ¸¡ã™
    system = PicklesSystem(
        user_id=args.user_id,  # Noneå¯ï¼ˆPhase 1aã§ã¯çœç•¥å¯èƒ½ï¼‰
        source_type=args.source,
        analysis_type=args.analysis,
        # ... ä»–ã®è¨­å®š
    )

    result = system.run_analysis()
```

---

### ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ 

```bash
# .env

# Supabaseè¨­å®š
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿè¡Œæ™‚ï¼‰
USER_ID=12345678-1234-1234-1234-123456789abc

# OpenAIè¨­å®šï¼ˆæ—¢å­˜ï¼‰
OPENAI_API_KEY=sk-...
EMBEDDING_MODEL=text-embedding-3-small
```

---

### GitHub Actions ã®ä¿®æ­£

```yaml
# .github/workflows/weekly_analysis.yml

jobs:
  analyze-users:
    strategy:
      matrix:
        # ğŸ†• ä¿®æ­£å¾Œ: Supabaseã‹ã‚‰å–å¾—
        # æ‰‹å‹•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒªã‚¹ãƒˆã‚’ç®¡ç†ã™ã‚‹ã‹ã€
        # å‹•çš„ã«Supabase APIã‹ã‚‰å–å¾—ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        user_id:
          - "12345678-1234-1234-1234-123456789abc"
          - "23456789-2345-2345-2345-234567890abc"
          # ... ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID

    steps:
      - uses: actions/checkout@v3

      - name: Run analysis
        env:
          USER_ID: ${{ matrix.user_id }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # UUIDã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦å®Ÿè¡Œ
          python run_analysis_by_user_id.py --user-id $USER_ID
```

---

### ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ‰‹é †

#### Step 1: Supabaseã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# 1. Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆhttps://supabase.comï¼‰
# 2. SQL Editorã§usersãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
# 3. ç’°å¢ƒå¤‰æ•°ã‚’.envã«è¿½åŠ 
```

#### Step 2: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç§»è¡Œ
```bash
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: æ‰‹å‹•SQL
# Supabase SQL Editorã§å®Ÿè¡Œ

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
python tools/migrate_users_from_sheet.py \
  --spreadsheet-id 1AbcDefGhi... \
  --output users_migrated.json
```

#### Step 3: read_spreadsheet_and_execute.py ã®åˆ‡ã‚Šæ›¿ãˆ
```bash
# ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼ˆå®Œå…¨ç§»è¡Œï¼‰ã‚’é¸æŠ
# ã¾ãŸã¯ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼‰ã‚’é¸æŠ

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python read_spreadsheet_and_execute.py \
  --mode supabase \
  --analysis domi \
  --delivery console
```

#### Step 4: æ¤œè¨¼
```bash
# 1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å‹•ä½œç¢ºèª
python main.py \
  --user-id 12345678-1234-1234-1234-123456789abc \
  --source notion \
  --analysis domi \
  --delivery console

# æˆåŠŸã—ãŸã‚‰ãƒãƒƒãƒå®Ÿè¡Œ
python read_spreadsheet_and_execute.py \
  --mode supabase \
  --analysis domi \
  --delivery email_html
```

---

### æ¨å¥¨å®Ÿè£…é †åº

```
1. âœ… Supabase usersãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆ5åˆ†ï¼‰
2. âœ… æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰‹å‹•SQLç™»éŒ²ï¼ˆ15åˆ†ï¼‰
3. âœ… main.py ã« --user-id å¼•æ•°è¿½åŠ ï¼ˆ30åˆ†ï¼‰
4. âœ… persistence/ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ user_id ã‚’ä½¿ç”¨ï¼ˆ1æ™‚é–“ï¼‰
5. â³ CLIç®¡ç†ãƒ„ãƒ¼ãƒ«å®Ÿè£…ï¼ˆ2æ™‚é–“ã€å¾Œå›ã—å¯ï¼‰
6. â³ read_spreadsheet_and_execute.py ä¿®æ­£ï¼ˆ1æ™‚é–“ã€Phase 1bä»¥é™ï¼‰
```

**Phase 1aã§ã®æ–¹é‡**:
- âœ… å˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§é–‹ç™ºãƒ»æ¤œè¨¼ï¼ˆ`--user-id`ã‚’ç’°å¢ƒå¤‰æ•°ã§æ¸¡ã™ï¼‰
- âœ… ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œã¯Phase 1bä»¥é™
- âœ… Google Sheetsã¨ã®çµ±åˆã¯Phase 1cä»¥é™

---

## ğŸ¯ å®Ÿè£…ãƒ—ãƒ©ãƒ³çµ±åˆç‰ˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†å«ã‚€ï¼‰

### Phase 0: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æº–å‚™ï¼ˆ1æ™‚é–“ï¼‰

**å®Ÿè£…å†…å®¹**:
- Supabase usersãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- read_spreadsheet_and_execute.py ã«è‡ªå‹•åŒæœŸæ©Ÿèƒ½è¿½åŠ 
- ç’°å¢ƒå¤‰æ•°è¨­å®š
- åˆå›åŒæœŸãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯**:
1. Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆ10åˆ†ï¼‰
2. usersãƒ†ãƒ¼ãƒ–ãƒ«SQLå®Ÿè¡Œï¼ˆ5åˆ†ï¼‰
3. .envã«SUPABASE_URL/KEYè¿½åŠ ï¼ˆ5åˆ†ï¼‰
4. `AutoSyncUserManager`ã‚¯ãƒ©ã‚¹å®Ÿè£…ï¼ˆ30åˆ†ï¼‰
5. åˆå›åŒæœŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆ10åˆ†ï¼‰

**å®Ÿè£…ã®å„ªå…ˆé †ä½**:
- ğŸ”´ **å¿…é ˆ**: Supabaseã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€usersãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- ğŸ”´ **å¿…é ˆ**: `AutoSyncUserManager`å®Ÿè£…
- ğŸŸ¡ **æ¨å¥¨**: åŒæœŸãƒ­ã‚°ã®ç¢ºèªã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

---

### Phase 1a: åŸºæœ¬ä¿å­˜ã¨æ¤œç´¢ï¼ˆ2-3æ—¥ï¼‰

**å®Ÿè£…å†…å®¹**:
- journals ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- å˜å±¤æ¤œç´¢ï¼ˆjournalsã®ã¿ï¼‰
- åŸºæœ¬ãƒ¬ãƒãƒ¼ãƒˆæ‹¡å¼µ

**ã‚¿ã‚¹ã‚¯**:
1. Supabaseã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆ1-2hï¼‰
2. `persistence/` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè£…ï¼ˆ3-4hï¼‰
3. `fermentation/embedder.py` å®Ÿè£…ï¼ˆ2hï¼‰
4. `fermentation/link_finder.py` å®Ÿè£…ï¼ˆ2hï¼‰
5. `main.py` çµ±åˆï¼ˆ2hï¼‰
6. `outputs/` æ‹¡å¼µï¼ˆ2hï¼‰
7. ãƒ†ã‚¹ãƒˆï¼ˆ2hï¼‰

### Phase 1b: é€±æ¬¡ç™ºé…µãƒãƒ¼ãƒ‰ï¼ˆ2-3æ—¥ï¼‰

**å®Ÿè£…å†…å®¹**:
- fermentation_nodes ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- fermentation_lineage ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- fermentation_recipes ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- é€±æ¬¡ç™ºé…µãƒãƒƒãƒå®Ÿè£…

**ã‚¿ã‚¹ã‚¯**:
1. ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µï¼ˆ1hï¼‰
2. `fermentation/batch_fermenter.py` å®Ÿè£…ï¼ˆ4hï¼‰
3. `persistence/fermentation_store.py` å®Ÿè£…ï¼ˆ3hï¼‰
4. é€±æ¬¡ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç™»éŒ²ï¼ˆ1hï¼‰
5. ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆï¼ˆ2hï¼‰
6. ãƒ†ã‚¹ãƒˆï¼ˆ2hï¼‰

### Phase 1c: å¤šå±¤æ¤œç´¢ï¼ˆ2æ—¥ï¼‰

**å®Ÿè£…å†…å®¹**:
- LayeredSearch ã‚¯ãƒ©ã‚¹
- ãƒ¬ã‚¤ãƒ¤ãƒ¼æ··åˆãƒ­ã‚¸ãƒƒã‚¯
- å¤šå±¤ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

**ã‚¿ã‚¹ã‚¯**:
1. `fermentation/layered_search.py` å®Ÿè£…ï¼ˆ4hï¼‰
2. ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›æ‹¡å¼µï¼ˆ3hï¼‰
3. RPCé–¢æ•°è¿½åŠ ï¼ˆ1hï¼‰
4. ãƒ†ã‚¹ãƒˆï¼ˆ2hï¼‰

### Phase 2: æœˆæ¬¡ãƒ»å››åŠæœŸãƒ»å¹´æ¬¡ç™ºé…µï¼ˆæ®µéšçš„ï¼‰

**å®Ÿè£…ã‚¿ã‚¤ãƒŸãƒ³ã‚°**:
- **æœˆæ¬¡ç™ºé…µ**: 1ãƒ¶æœˆå¾Œï¼ˆé€±æ¬¡ãƒ‡ãƒ¼ã‚¿ãŒ4é€±åˆ†æºœã¾ã£ã¦ã‹ã‚‰ï¼‰
- **å››åŠæœŸç™ºé…µ**: 3ãƒ¶æœˆå¾Œï¼ˆæœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ãŒ3æœˆåˆ†æºœã¾ã£ã¦ã‹ã‚‰ï¼‰
- **å¹´æ¬¡ç™ºé…µ**: 1å¹´å¾Œï¼ˆå››åŠæœŸãƒ‡ãƒ¼ã‚¿ãŒ4æœŸåˆ†æºœã¾ã£ã¦ã‹ã‚‰ï¼‰

**å®Ÿè£…å†…å®¹**ï¼ˆå„ãƒ¬ã‚¤ãƒ¤ãƒ¼å…±é€šï¼‰:
1. ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç™»éŒ²
2. ãƒãƒƒãƒå‡¦ç†è¿½åŠ 
3. GitHub Actionsè¨­å®š
4. ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›èª¿æ•´

---

## ğŸ¤” è¨­è¨ˆä¸Šã®è€ƒæ…®ç‚¹

### Q1: ç™ºé…µãƒãƒƒãƒã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ï¼Ÿ
**A**: GitHub Actionsã§å®šæœŸå®Ÿè¡Œ
- é€±æ¬¡: æ¯é€±æœˆæ›œ7:00ï¼ˆé€±æ˜ã‘ã«å…ˆé€±åˆ†ã‚’ç™ºé…µï¼‰
- æœˆæ¬¡: æ¯æœˆ1æ—¥8:00ï¼ˆæœˆåˆã«å…ˆæœˆåˆ†ã‚’ç™ºé…µï¼‰
- å­£ç¯€: å››åŠæœŸåˆæ—¥9:00
- å¹´æ¬¡: æ¯å¹´1æœˆ1æ—¥10:00

### Q2: ç™ºé…µãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã©ã†ç®¡ç†ã™ã‚‹ï¼Ÿ
**A**: fermentation_recipes ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†å¯èƒ½
- A/Bãƒ†ã‚¹ãƒˆå¯èƒ½ï¼ˆåŒã˜layer_typeã§ç•°ãªã‚‹recipe_idï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ï¼ˆå°†æ¥æ‹¡å¼µï¼‰

### Q3: ç™ºé…µãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ„å‘³ã¯ï¼Ÿ
**A**:
- **diversity**: å…ƒãƒ‡ãƒ¼ã‚¿é–“ã®å¤šæ§˜æ€§ï¼ˆé«˜ã„ã»ã©è±Šã‹ï¼‰
- **emergence**: å…ƒãƒ‡ãƒ¼ã‚¿ã¨ç™ºé…µå¾Œã®è·é›¢ï¼ˆé«˜ã„ã»ã©å‰µç™ºçš„ï¼‰
- **density**: æƒ…å ±ã®å‡ç¸®åº¦ï¼ˆé«˜ã„ã»ã©åœ§ç¸®çš„ï¼‰

### Q4: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œç´¢ã®é‡ã¿ä»˜ã‘ã¯èª¿æ•´å¯èƒ½ï¼Ÿ
**A**: ã¯ã„
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: journals 50% / weekly 30% / monthly 15% / quarterly 5%
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å¥½ã¿ã§èª¿æ•´å¯èƒ½ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
- ã€Œæœ€è¿‘ã®è‡ªåˆ†é‡è¦–ã€ã€Œé•·æœŸçš„è¦–ç‚¹é‡è¦–ã€ãªã©ãƒ—ãƒªã‚»ãƒƒãƒˆæä¾›

### Q5: ã‚³ã‚¹ãƒˆå¢—åŠ ã¯ï¼Ÿ
**A**:
- é€±æ¬¡ç™ºé…µ: ç´„$0.01/é€±ï¼ˆGPT-4ã§ã®å¤‰æ€§ç”Ÿæˆï¼‰
- æœˆæ¬¡ç™ºé…µ: ç´„$0.02/æœˆ
- å¹´é–“ã‚³ã‚¹ãƒˆ: ç´„$10-15/ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼å«ã‚€ï¼‰
- Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1å¹´ã§ç´„3-5MB

---

## ğŸ› ï¸ ç’°å¢ƒå¤‰æ•°è¿½åŠ 

```bash
# ===== Supabaseè¨­å®šï¼ˆæ–°è¦è¿½åŠ ï¼‰=====
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...  # anon/public key

# ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¨­å®š =====
# å˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿè¡Œæ™‚ã«ä½¿ç”¨ï¼ˆPhase 1aé–‹ç™ºæ™‚ï¼‰
USER_ID=12345678-1234-1234-1234-123456789abc

# ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿè¡Œæ™‚ï¼ˆPhase 1bä»¥é™ï¼‰
# read_spreadsheet_and_execute.py ãŒ Supabase ã‹ã‚‰è‡ªå‹•å–å¾—

# ===== OpenAIè¨­å®šï¼ˆæ—¢å­˜ï¼‰ =====
OPENAI_API_KEY=sk-...  # æ—¢å­˜
OPENAI_MODEL=gpt-4o-mini  # æ—¢å­˜ï¼ˆåˆ†æç”¨ï¼‰

# ===== OpenAI Embeddingsè¨­å®šï¼ˆæ–°è¦è¿½åŠ ï¼‰=====
EMBEDDING_MODEL=text-embedding-3-small
EMBED_DIM=1536

# ===== ç™ºé…µãƒãƒƒãƒè¨­å®šï¼ˆPhase 1bä»¥é™ï¼‰=====
FERMENTATION_MODEL=gpt-4
FERMENTATION_TEMPERATURE=0.7
```

### ç’°å¢ƒå¤‰æ•°å–å¾—ã®å„ªå…ˆé †ä½

```python
# persistence/supabase_client.py

def get_user_id() -> str:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ï¼ˆå„ªå…ˆé †ä½ä»˜ãï¼‰"""

    # 1. å¼•æ•°ã§æ˜ç¤ºçš„ã«æ¸¡ã•ã‚ŒãŸå ´åˆï¼ˆæœ€å„ªå…ˆï¼‰
    # 2. ç’°å¢ƒå¤‰æ•° USER_IDï¼ˆå˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼é–‹ç™ºæ™‚ï¼‰
    user_id = os.getenv('USER_ID')
    if user_id:
        return user_id

    # 3. ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œï¼ˆPhase 1bä»¥é™ï¼‰
    # å®Ÿè¡Œæ™‚ã«å‹•çš„ã«æ±ºå®šã•ã‚Œã‚‹

    raise ValueError("USER_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
```

---

## ğŸ“¦ ä¾å­˜é–¢ä¿‚è¿½åŠ 

```toml
[project]
dependencies = [
    "notion-client>=2.3.0",
    "openai>=1.84.0",
    "python-dotenv>=1.1.0",
    "google-auth>=2.29.0",
    "google-api-python-client>=2.137.0",
    "supabase>=2.0.0",  # æ–°è¦è¿½åŠ 
]
```

---

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

### æŠ€è¡“æŒ‡æ¨™
- âœ… å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒ¼ãƒ‰ãŒæ­£å¸¸ç”Ÿæˆã•ã‚Œã‚‹
- âœ… å¤šå±¤æ¤œç´¢ãŒ1ç§’ä»¥å†…ã«å®Œäº†
- âœ… ç™ºé…µãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒé©åˆ‡ãªç¯„å›²ï¼ˆdiversity 0.3-0.8ç­‰ï¼‰
- âœ… ãƒãƒƒãƒå‡¦ç†ãŒå®šæœŸå®Ÿè¡Œã•ã‚Œã‚‹

### ä½“é¨“æŒ‡æ¨™
- âœ… ã€Œæ™‚é–“ã®å¤‰å®¹ã€ã‚’å®Ÿæ„Ÿã§ãã‚‹
- âœ… éå»ã®è‡ªåˆ†ã®ã€Œç†Ÿæˆã€ã«æ°—ã¥ã
- âœ… ç•°ãªã‚‹æ™‚é–“ã‚¹ã‚±ãƒ¼ãƒ«ã§ã®æ¥ç¶šã«é©šã
- âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã¾ãŸã„ã å¯¾è©±ãŒç”Ÿã¾ã‚Œã‚‹

### ç™ºé…µæŒ‡æ¨™
- âœ… emergence > 0.5ï¼ˆå‰µç™ºæ€§ãŒé«˜ã„ï¼‰
- âœ… diversity 0.3-0.8ï¼ˆé©åº¦ãªå¤šæ§˜æ€§ï¼‰
- âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã®é¡ä¼¼åº¦ 0.4-0.7ï¼ˆé©åº¦ãªè·é›¢ï¼‰

---

## ğŸ“š å‚è€ƒè³‡æ–™

### ç™ºé…µã®æ¦‚å¿µ
- [ç™ºé…µç¾è±¡ã‚’ãƒ‡ã‚¸ã‚¿ãƒ«ã«ä½œã‚‹ã¨ãã«å¿…è¦ãªè€ƒãˆæ–¹](https://kangaeruhito.jp/article/762492)
- è¤‡é›‘åŒ–ã«ã‚ˆã‚‹å‰µç™º
- æ™‚é–“ã«ã‚ˆã‚‹å¤‰å®¹
- å¾®ç”Ÿç‰©ï¼ˆAIï¼‰ã®ä»£è¬

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- [Supabase pgvector](https://supabase.com/docs/guides/ai/vector-columns)
- [OpenAI Embeddings API](https://platform.openai.com/docs/guides/embeddings)
- [GitHub Actions ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule)

---

## ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã®æˆåŠŸæŒ‡æ¨™

### æŠ€è¡“æŒ‡æ¨™
- âœ… usersãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã€RLSãŒæœ‰åŠ¹
- âœ… æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒSupabaseã«ç§»è¡Œå®Œäº†ï¼ˆUUIDãŒä»˜ä¸ã•ã‚Œã‚‹ï¼‰
- âœ… main.py ãŒ --user-id å¼•æ•°ã‚’å—ã‘å–ã‚Œã‚‹
- âœ… journals ã¨ fermentation_nodes ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§åˆ†é›¢ã•ã‚Œã‚‹

### é‹ç”¨æŒ‡æ¨™
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ãŒ5åˆ†ä»¥å†…ã«å®Œäº†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³A or Bï¼‰
- âœ… Google Sheetsã‹ã‚‰ã®ç§»è¡ŒãŒã‚¨ãƒ©ãƒ¼ãªãå®Œäº†
- âœ… ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒå®Ÿè¡ŒãŒæ­£å¸¸å‹•ä½œ
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ãŒåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆçµ±åˆç‰ˆï¼‰

### å³æ™‚å®Ÿè¡Œï¼ˆPhase 0ï¼‰
1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æº–å‚™**: Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã€usersãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã€åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼ˆ30åˆ†ï¼‰

### Phase 1aå®Ÿè£…ï¼ˆ2-3æ—¥ï¼‰
2. **åŸºæœ¬ä¿å­˜ã¨å˜å±¤æ¤œç´¢**: journals ãƒ†ãƒ¼ãƒ–ãƒ«ã€persistence/ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€embedderã€å˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§æ¤œè¨¼

### Phase 1bå®Ÿè£…ï¼ˆ2-3æ—¥ï¼‰
3. **é€±æ¬¡ç™ºé…µãƒãƒ¼ãƒ‰**: fermentation_nodesã€batch_fermenterã€é€±æ¬¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€CLIç®¡ç†ãƒ„ãƒ¼ãƒ«è¿½åŠ 

### Phase 1cå®Ÿè£…ï¼ˆ2æ—¥ï¼‰
4. **å¤šå±¤æ¤œç´¢**: LayeredSearchã€ãƒ¬ã‚¤ãƒ¤ãƒ¼æ··åˆã€read_spreadsheet_and_execute.py ã®Supabaseçµ±åˆ

### Phase 2å®Ÿè£…ï¼ˆãƒ‡ãƒ¼ã‚¿è“„ç©å¾Œï¼‰
5. **æœˆæ¬¡ãƒ»å››åŠæœŸãƒ»å¹´æ¬¡ç™ºé…µ**: å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒƒãƒå‡¦ç†ã€GitHub Actionsã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

---

## ğŸ“ å®Ÿè£…ã®å„ªå…ˆé †ä½ã¾ã¨ã‚

| é …ç›® | Phase | å„ªå…ˆåº¦ | å®Ÿè£…æ™‚é–“ |
|------|-------|--------|---------|
| usersãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ | 0 | ğŸ”´ å¿…é ˆ | 5åˆ† |
| åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² | 0 | ğŸ”´ å¿…é ˆ | 15åˆ† |
| main.py ã«user_idè¿½åŠ  | 1a | ğŸ”´ å¿…é ˆ | 30åˆ† |
| journalsæ°¸ç¶šåŒ– | 1a | ğŸ”´ å¿…é ˆ | 3-4æ™‚é–“ |
| å˜å±¤ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ | 1a | ğŸ”´ å¿…é ˆ | 2-3æ™‚é–“ |
| CLIç®¡ç†ãƒ„ãƒ¼ãƒ« | 1b | ğŸŸ¡ æ¨å¥¨ | 2-3æ™‚é–“ |
| read_spreadsheetä¿®æ­£ | 1c | ğŸŸ¡ æ¨å¥¨ | 1æ™‚é–“ |
| Webç®¡ç†ç”»é¢ | 2+ | ğŸŸ¢ å°†æ¥ | 1-2æ—¥ |

---

## ğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç§»è¡Œã®å…¨ä½“åƒ

### ç¾åœ¨ â†’ Phase 0 â†’ Phase 2 ã®å¤‰é·

```
ã€ç¾åœ¨ã€‘Google Sheetsä¸­å¿ƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Sheets (çœŸå®Ÿã®æºæ³‰)          â”‚
â”‚  Aåˆ—: EMAIL_TO                      â”‚
â”‚  Båˆ—: NOTION_API_KEY                â”‚
â”‚  Cåˆ—: GOOGLE_DOCS_URL               â”‚
â”‚  Dåˆ—: user name                     â”‚
â”‚  Eåˆ—: LANGUAGE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
  read_spreadsheet_and_execute.py
         â†“
    main.py ã§åˆ†æå®Ÿè¡Œ

ã€Phase 0ã€‘è‡ªå‹•åŒæœŸï¼ˆä»Šã™ãå®Ÿè£…ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Sheets (ç·¨é›†ç”¨)              â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ãƒ»æ›´æ–°ã¯ã“ã“ã§å®Ÿæ–½      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ è‡ªå‹•åŒæœŸï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚­ãƒ¼ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase users ãƒ†ãƒ¼ãƒ–ãƒ«             â”‚
â”‚  id (UUID) - è‡ªå‹•ç”Ÿæˆ               â”‚
â”‚  email (unique)                     â”‚
â”‚  user_name, language                â”‚
â”‚  notion_api_key, google_docs_url    â”‚
â”‚  last_analysis_at                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
  AutoSyncUserManager
         â†“
    main.py ã§åˆ†æå®Ÿè¡Œï¼ˆuser_idä»˜ãï¼‰

ã€Phase 1cã€‘Supabaseä¸­å¿ƒã¸ç§»è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Sheets (å‚ç…§ã®ã¿)            â”‚
â”‚  æ–°è¦è¿½åŠ ãªã—ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ä¿æŒ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase users ãƒ†ãƒ¼ãƒ–ãƒ« (çœŸå®Ÿã®æºæ³‰)â”‚
â”‚  æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç›´æ¥ã“ã“ã¸è¿½åŠ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
  CLI: python tools/user_manager.py add
         â†“
    main.py ã§åˆ†æå®Ÿè¡Œ

ã€Phase 2ã€‘Web UIå®Œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pickles-admin (Next.js)             â”‚
â”‚  /login    - èªè¨¼                   â”‚
â”‚  /users    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†           â”‚
â”‚  /users/new - ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ CRUDæ“ä½œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase (å®Œå…¨çµ±åˆ)                 â”‚
â”‚  users - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†               â”‚
â”‚  journals - æ—¥è¨˜ãƒ‡ãƒ¼ã‚¿              â”‚
â”‚  fermentation_nodes - ç™ºé…µãƒãƒ¼ãƒ‰    â”‚
â”‚  + Supabase Auth                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
  åˆ†æå®Ÿè¡Œã€å±¥æ­´å¯è¦–åŒ–ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
```

### å„ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ–¹æ³•

| ãƒ•ã‚§ãƒ¼ã‚º | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ æ–¹æ³• | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†æ–¹æ³• | ãƒ‡ãƒ¼ã‚¿ã®çœŸå®Ÿã®æºæ³‰ |
|---------|----------------|----------------|------------------|
| ç¾åœ¨ | Google Sheetsã«è¡Œè¿½åŠ  | Sheetsä¸Šã§ç·¨é›† | Google Sheets |
| Phase 0 | Google Sheetsã«è¡Œè¿½åŠ  â†’ è‡ªå‹•åŒæœŸ | Sheetsä¸Šã§ç·¨é›† â†’ è‡ªå‹•åŒæœŸ | Google Sheets |
| Phase 1c | CLI: `user_manager.py add` | CLI: Supabaseç›´æ¥ç·¨é›† | Supabase |
| Phase 2 | Web UI: `/users/new` | Web UI: `/users/[id]/edit` | Supabase |

### ç§»è¡Œæ™‚ã®æ³¨æ„ç‚¹

**Phase 0 â†’ Phase 1c**:
- âœ… Google Sheetsã¯å‰Šé™¤ã—ãªã„ï¼ˆå‚ç…§ç”¨ã¨ã—ã¦ä¿æŒï¼‰
- âœ… æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ `AutoSyncUserManager` ã‚’çµŒç”±ã›ãšç›´æ¥Supabaseã¸
- âœ… `read_spreadsheet_and_execute.py` ã¯å¾ã€…ã«ä½¿ç”¨é »åº¦ã‚’ä¸‹ã’ã‚‹

**Phase 1c â†’ Phase 2**:
- âœ… Web UIã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚’å„ªå…ˆ
- âœ… CLIãƒ„ãƒ¼ãƒ«ã¯é–‹ç™ºè€…ç”¨ã¨ã—ã¦æ®‹ã™
- âœ… Google Sheetså®Œå…¨å»ƒæ­¢ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ±ºå®š

### ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ç†ç”±

1. **ä¸€æ„æ€§**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯è‡ªç„¶ãªä¸€æ„ã‚­ãƒ¼
2. **å¯èª­æ€§**: UUIDã‚ˆã‚Šã‚‚äººé–“ãŒè­˜åˆ¥ã—ã‚„ã™ã„
3. **ç§»è¡Œå®¹æ˜“æ€§**: Sheets â†’ Supabase ã®ç…§åˆãŒç°¡å˜
4. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¯¾å¿œ**: ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ã«ã‚‚ä½¿ç”¨å¯èƒ½
5. **å¤‰æ›´ä¸å¯**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¤‰æ›´ã•ã‚Œã«ãã„ï¼ˆå¤‰æ›´æ™‚ã¯Supabaseã§å¯¾å¿œï¼‰

### ä»Šã™ãå®Ÿè£…ã™ã¹ãã“ã¨ï¼ˆPhase 0ï¼‰

1. âœ… Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
2. âœ… `users`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆSQLå®Ÿè¡Œï¼‰
3. âœ… `.env`ã«`SUPABASE_URL`ã¨`SUPABASE_KEY`è¿½åŠ 
4. âœ… `read_spreadsheet_and_execute.py`ã«`AutoSyncUserManager`å®Ÿè£…
5. âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã—ã¦åŒæœŸç¢ºèª

---

*æœ€çµ‚æ›´æ–°: 2025-12-03*
*ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 3.0ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†çµ±åˆç‰ˆ - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç§»è¡Œãƒ‘ã‚¹æ˜ç¢ºåŒ–ï¼‰*
